<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Insurance Dashboard - Fast Entry</title>
    
    <!-- Link to Google Fonts for Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    fontSize: {
                        'xxs': '0.65rem',
                    },
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    boxShadow: {
                        'subtle': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Minimal styles to replace potential root.css for preview */
        body { margin: 0; }
        /* Custom scrollbar for better UI feel */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Utility for uploaded pill state */
        .doc-pill.uploaded {
            background-color: #ecfdf5; /* emerald-50 */
            color: #047857; /* emerald-700 */
            border-color: #a7f3d0; /* emerald-200 */
            padding-right: 1.75rem; /* space for X icon */
            position: relative;
        }
        
        /* Fade animation */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 h-screen overflow-hidden font-sans text-slate-600 antialiased selection:bg-indigo-100 selection:text-indigo-700">

    <!-- DEBUG CONSOLE PANEL -->
    <div id="debug-console" style="position: fixed; bottom: 10px; right: 10px; width: 350px; height: 200px; background: #1e293b; color: #94a3b8; border: 1px solid #475569; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; overflow-y: auto; z-index: 9999; display: none;">
        <div style="font-weight: bold; margin-bottom: 8px; color: #cbd5e1; border-bottom: 1px solid #475569; padding-bottom: 8px;">
            DEBUG LOGS <button onclick="document.getElementById('debug-console').style.display='none'" style="float: right; background: none; border: none; color: #94a3b8; cursor: pointer;">✕</button>
        </div>
        <div id="debug-console-content" style="max-height: 160px; overflow-y: auto;"></div>
    </div>

    <script>
        // Intercept console logs to display in debug panel
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addDebugLog(msg, color = '#94a3b8') {
            const content = document.getElementById('debug-console-content');
            if (content) {
                const line = document.createElement('div');
                line.style.color = color;
                line.textContent = msg;
                content.appendChild(line);
                content.scrollTop = content.scrollHeight;
            }
        }
        
        console.log = function(...args) {
            originalLog(...args);
            addDebugLog('[LOG] ' + args.join(' '));
            if (args[0] && args[0].toString().includes('[DASH]')) {
                document.getElementById('debug-console').style.display = 'block';
            }
        };
        
        console.error = function(...args) {
            originalError(...args);
            addDebugLog('[ERROR] ' + args.join(' '), '#ef4444');
            document.getElementById('debug-console').style.display = 'block';
        };
        
        console.warn = function(...args) {
            originalWarn(...args);
            addDebugLog('[WARN] ' + args.join(' '), '#f59e0b');
            document.getElementById('debug-console').style.display = 'block';
        };
    </script>

    <div class="grid grid-cols-[420px_1fr] h-full">
        
        <!-- LEFT SIDE: FORM CONTAINER -->
        <div class="bg-white h-full overflow-y-auto border-r border-slate-200 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10 relative">
            <div class="p-6">
                <header class="mb-6 pb-5 border-b border-slate-100 flex items-center justify-between">
                    <h1 class="text-lg font-bold text-slate-800 flex items-center gap-3">
                        <button type="button" onclick="goBackToMeta()" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-slate-800 flex items-center justify-center text-sm shadow-sm transition-all" title="Back to Meta Leads">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <span class="w-8 h-8 rounded-lg bg-indigo-600 text-white flex items-center justify-center text-sm shadow-md shadow-indigo-200">
                            <i class="fa-solid fa-file-shield"></i>
                        </span>
                        Dashboard
                    </h1>
                    <div class="text-xs font-medium text-slate-400 bg-slate-50 px-2 py-1 rounded-md border border-slate-100">v2.9</div>
                </header>

                <!-- CUSTOMER SEARCH MODULE -->
                <div class="mb-8">
                    <!-- Search Input State -->
                    <div id="customer-search-block" class="block">
                        <label class="block text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2">Find Customer</label>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400">
                                    <i class="fa-solid fa-magnifying-glass text-xs"></i>
                                </div>
                                <input type="text" id="customer-search-input" placeholder="Search by Name or Phone..." 
                                    class="h-10 w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 block pl-9 px-3 transition-all"
                                    onkeyup="showSearchSuggestions()"
                                    onkeydown="if(event.key === 'Enter') performSearch()">
                            </div>
                            <button type="button" onclick="performSearch()" class="h-10 px-4 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-xs font-bold transition-all shadow-sm">
                                Search
                            </button>
                        </div>
                        <p class="mt-2 text-[10px] text-slate-400">Start typing a name or phone number to see suggestions...</p>
                    </div>

                    <!-- Customer Selected State (Hidden by default) -->
                    <div id="customer-selected-block" class="hidden fade-in">
                        <label class="block text-[11px] font-bold text-emerald-600 uppercase tracking-wider mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-check-circle"></i> Active Customer
                        </label>
                        <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-3 flex items-center justify-between shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs font-bold border border-emerald-200">
                                    JD
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-slate-800" id="selected-customer-name">John Doe</div>
                                    <div class="text-xs text-slate-500" id="selected-customer-phone">416-555-0123</div>
                                    <div class="text-xs text-slate-400" id="selected-customer-email">john@email.com</div>
                                </div>
                            </div>
                            <button onclick="clearCustomer()" class="text-slate-400 hover:text-rose-500 transition-colors px-2 py-1" title="Change Customer">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- WORKFLOW CONTAINER (Visible but Disabled until customer selected) -->
                <div id="workflow-container" class="opacity-50 pointer-events-none transition-all duration-300">
                    
                    <!-- Main Type Switcher (Auto / Property) -->
                    <div class="mb-8 flex p-1 bg-slate-100 rounded-xl border border-slate-200">
                        <button type="button" onclick="switchEntryMode('auto')" id="btn-entry-auto" class="flex-1 py-2 rounded-lg text-xs font-bold text-white bg-slate-800 shadow-sm transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-car"></i> Auto
                        </button>
                        <button type="button" onclick="switchEntryMode('property')" id="btn-entry-property" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-house"></i> Property
                        </button>
                    </div>

                    <!-- AUTO FORM SECTION -->
                    <div id="entry-form-auto" class="block">
                        <header class="mb-6 pb-4 border-b border-slate-100 flex items-center justify-between">
                            <h1 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                                <span class="w-6 h-6 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs">
                                    <i class="fa-solid fa-file-shield"></i>
                                </span>
                                Auto Entry
                            </h1>
                        </header>
                        
                        <form id="quoteFormAuto" class="space-y-8">
                            <!-- DRIVER DOCUMENTS -->
                            <section>
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                        <i class="fa-solid fa-users text-indigo-500"></i> Driver Documents
                                    </h2>
                                </div>
                                
                                <div id="driversList" class="space-y-4">
                                    <!-- Driver 1 (Default) -->
                                    <div class="upload-row group relative bg-white rounded-xl p-1 border border-slate-200 shadow-sm hover:border-indigo-300 hover:shadow-md transition-all" data-driver="1">
                                        <div class="bg-slate-50/50 rounded-lg p-3">
                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="driver-num w-6 h-6 rounded-full bg-slate-200 text-slate-600 text-xs font-bold flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-colors shadow-sm">1</div>
                                                
                                                <div class="flex-1 grid grid-cols-3 gap-2 doc-type-pills">
                                                    <button type="button" class="doc-pill active h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate bg-slate-800 text-white border-slate-800 shadow-sm" 
                                                        data-type="dash" onclick="selectDocType(1, 'dash')">DASH</button>
                                                    <button type="button" class="doc-pill h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate border-slate-200 bg-white text-slate-500 hover:bg-slate-50 hover:border-slate-300 hover:text-slate-700" 
                                                        data-type="autoplus" onclick="selectDocType(1, 'autoplus')">Auto+</button>
                                                    <button type="button" class="doc-pill h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate border-slate-200 bg-white text-slate-500 hover:bg-slate-50 hover:border-slate-300 hover:text-slate-700" 
                                                        data-type="mvr" onclick="selectDocType(1, 'mvr')">MVR</button>
                                                </div>
                                            </div>
                                            
                                            <div class="pl-9">
                                                <select id="rel-1" onchange="updateDriverRel(1)" class="h-9 w-full bg-white border border-slate-200 text-slate-700 text-xs font-medium rounded-lg focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 block px-3 transition-all cursor-pointer hover:border-slate-300">
                                                    <option value="">Select Relationship</option>
                                                    <option value="applicant" selected>Applicant</option>
                                                    <option value="spouse">Spouse</option>
                                                    <option value="son">Son</option>
                                                    <option value="daughter">Daughter</option>
                                                    <option value="parent">Parent</option>
                                                    <option value="sibling">Sibling</option>
                                                    <option value="other">Other</option>
                                                </select>
                                                <input type="file" id="file-1" class="hidden" accept=".pdf" onchange="handleFileUpload(1)">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" onclick="addDriver()" class="mt-4 w-full h-9 border border-dashed border-slate-300 rounded-lg text-slate-500 text-xs font-medium hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-300 transition-all flex items-center justify-center gap-2 group">
                                    <span class="w-4 h-4 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center text-[10px] group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors"><i class="fa-solid fa-plus"></i></span>
                                    Add Another Driver
                                </button>
                            </section>
                            
                            <!-- VEHICLE DETAILS -->
                            <section>
                                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-car text-indigo-500"></i> Vehicle Details
                                </h2>
                                <div class="space-y-5">
                                    <div>
                                        <label class="block text-[11px] font-semibold text-slate-500 mb-2">Ownership</label>
                                        <div class="btn-group grid grid-cols-3 gap-2">
                                            <label class="cursor-pointer"><input type="radio" name="ownership" value="owned" checked class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">Owned</div></label>
                                            <label class="cursor-pointer"><input type="radio" name="ownership" value="financed" class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">Financed</div></label>
                                            <label class="cursor-pointer"><input type="radio" name="ownership" value="leased" class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">Leased</div></label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-[11px] font-semibold text-slate-500 mb-2">Vehicle Use</label>
                                        <div class="btn-group grid grid-cols-3 gap-2">
                                            <label class="cursor-pointer"><input type="radio" name="use" value="pleasure" checked class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">Pleasure</div></label>
                                            <label class="cursor-pointer"><input type="radio" name="use" value="commute" class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">Commute</div></label>
                                            <label class="cursor-pointer"><input type="radio" name="use" value="business" class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">Business</div></label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-[11px] font-semibold text-slate-500 mb-2">Annual KM</label>
                                        <div class="relative">
                                            <input type="number" id="annualKm" placeholder="e.g. 15000" min="0" step="1000" class="h-9 w-full bg-white border border-slate-200 text-slate-700 text-sm font-medium rounded-lg focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 block px-3 transition-all placeholder:text-slate-300">
                                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-xs text-slate-400 font-medium">km</div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-[11px] font-semibold text-slate-500 mb-2">Winter Tires</label>
                                            <div class="btn-group grid grid-cols-2 gap-2">
                                                <label class="cursor-pointer"><input type="radio" name="winterTires" value="yes" checked class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">Yes</div></label>
                                                <label class="cursor-pointer"><input type="radio" name="winterTires" value="no" class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">No</div></label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-[11px] font-semibold text-slate-500 mb-2">Anti-Theft</label>
                                            <div class="btn-group grid grid-cols-2 gap-2">
                                                <label class="cursor-pointer"><input type="radio" name="antiTheft" value="yes" class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">Yes</div></label>
                                                <label class="cursor-pointer"><input type="radio" name="antiTheft" value="no" checked class="hidden peer"><div class="h-9 flex items-center justify-center text-xs font-medium bg-white border border-slate-200 rounded-lg text-slate-600 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 peer-checked:shadow-md hover:bg-slate-50 transition-all">No</div></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- CONTACT INFO -->
                            <section>
                                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                                    <i class="fa-regular fa-address-card text-indigo-500"></i> Contact Info
                                </h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-[11px] font-semibold text-slate-500 mb-2">Phone Number</label>
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fa-solid fa-phone text-slate-400 text-xs"></i></div>
                                            <input type="tel" id="phone" placeholder="(416) 555-0123" class="h-9 w-full bg-white border border-slate-200 text-slate-900 text-sm font-medium rounded-lg focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 block pl-9 px-3 transition-all placeholder:text-slate-300">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-[11px] font-semibold text-slate-500 mb-2">Email Address</label>
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fa-solid fa-envelope text-slate-400 text-xs"></i></div>
                                            <input type="email" id="email" placeholder="client@email.com" class="h-9 w-full bg-white border border-slate-200 text-slate-900 text-sm font-medium rounded-lg focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 block pl-9 px-3 transition-all placeholder:text-slate-300">
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- ACTIONS -->
                            <div class="pt-6 space-y-3 pb-6">
                                <button type="submit" class="h-11 w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold text-sm rounded-xl shadow-lg shadow-slate-900/10 hover:shadow-xl hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2">
                                    <i class="fa-regular fa-floppy-disk"></i> Save Quote
                                </button>
                                <button type="button" onclick="clearForm()" class="h-10 w-full text-rose-600 bg-rose-50 hover:bg-rose-100 hover:text-rose-700 font-semibold text-xs rounded-xl transition-all duration-200 flex items-center justify-center gap-2 border border-rose-100">
                                    <i class="fa-regular fa-trash-can"></i> Clear All
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- PROPERTY FORM SECTION (HIDDEN INITIALLY) -->
                    <div id="entry-form-property" class="hidden">
                        <header class="mb-6 pb-4 border-b border-slate-100 flex items-center justify-between">
                            <h1 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                                <span class="w-6 h-6 rounded bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs">
                                    <i class="fa-solid fa-house-chimney"></i>
                                </span>
                                Property Entry
                            </h1>
                        </header>

                        <!-- Property List / Tabs -->
                        <div class="mb-6">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Properties</label>
                            <div class="flex flex-wrap gap-2" id="property-tabs-container">
                                <!-- JS will populate this -->
                            </div>
                            <div class="flex items-center gap-2 mt-2">
                                <button onclick="addNewProperty()" class="text-xs font-bold text-emerald-600 hover:text-emerald-700 flex items-center gap-1 transition-colors">
                                    <i class="fa-solid fa-plus-circle"></i> Add Property
                                </button>
                                <button onclick="deleteActiveProperty()" class="text-xs font-bold text-rose-500 hover:text-rose-700 flex items-center gap-1 ml-4 transition-colors" id="btn-delete-prop">
                                    <i class="fa-regular fa-trash-can"></i> Remove Selected
                                </button>
                            </div>
                        </div>

                        <form id="quoteFormProperty" class="space-y-6">
                            
                            <!-- 1. Property Basics -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">1. Property Basics</h3>
                                
                                <!-- Property Type Selection -->
                                <div>
                                    <select id="prop-type" onchange="updatePropertyType()" class="w-full h-8 text-xs border-slate-200 rounded bg-slate-50 focus:ring-emerald-500 focus:border-emerald-500 font-bold text-slate-700">
                                        <option value="Primary Home">Primary Home</option>
                                        <option value="Secondary - Rented">Secondary - Rented</option>
                                        <option value="Secondary - Non Rented">Secondary - Non Rented</option>
                                        <option value="Vacation Home">Vacation Home</option>
                                    </select>
                                </div>

                                <div><input type="text" id="prop-address" placeholder="Property Address" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()"></div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="prop-city" placeholder="City" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                    <input type="text" id="prop-postal" placeholder="Postal Code" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                </div>
                            </div>

                            <!-- 2. Ownership -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">2. Ownership</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="prop-purchased" placeholder="When purchased?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                    <input type="text" id="prop-first-insured" placeholder="First insured year?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                </div>
                                <div class="flex items-center justify-between text-xs text-slate-600 bg-slate-50 p-2 rounded">
                                    <span>Owner-occupied?</span>
                                    <div class="flex gap-2">
                                        <label><input type="radio" name="prop-owner-occ" value="Yes" onchange="saveAndPreviewProp()" checked> Yes</label>
                                        <label><input type="radio" name="prop-owner-occ" value="No" onchange="saveAndPreviewProp()"> No</label>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Mortgage -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">3. Mortgage</h3>
                                <div class="flex items-center justify-between text-xs text-slate-600 bg-slate-50 p-2 rounded">
                                    <span>Mortgage?</span>
                                    <div class="flex gap-2">
                                        <label><input type="radio" name="prop-mortgage" value="Yes" onchange="saveAndPreviewProp()" checked> Yes</label>
                                        <label><input type="radio" name="prop-mortgage" value="No" onchange="saveAndPreviewProp()"> No</label>
                                    </div>
                                </div>
                                <input type="text" id="prop-lender" placeholder="Mortgage lender name?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                <input type="number" id="prop-mortgage-count" placeholder="Number of mortgages?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                            </div>

                            <!-- 4. Home Details -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">4. Home Details</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="prop-year-built" placeholder="Year built?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                    <input type="text" id="prop-storeys" placeholder="Storeys?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                    <input type="number" id="prop-units" placeholder="Units?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                    <input type="number" id="prop-families" placeholder="Families?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                </div>
                            </div>

                            <!-- 5. Bathrooms -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">5. Bathrooms</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="prop-full-baths" placeholder="Full baths?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                    <input type="number" id="prop-half-baths" placeholder="Half baths?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                </div>
                            </div>

                            <!-- 6. Area -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">6. Area</h3>
                                <input type="number" id="prop-living-area" placeholder="Total living area (sq ft)?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="prop-basement-area" placeholder="Bsmt area (sq ft)?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                    <input type="number" id="prop-basement-fin" placeholder="Bsmt finished %?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                </div>
                            </div>

                            <!-- 7. Suites -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">7. Suites</h3>
                                <div class="flex items-center justify-between text-xs text-slate-600 bg-slate-50 p-2 rounded">
                                    <span>In-law suite?</span>
                                    <div class="flex gap-2">
                                        <label><input type="radio" name="prop-inlaw" value="Yes" onchange="saveAndPreviewProp()"> Yes</label>
                                        <label><input type="radio" name="prop-inlaw" value="No" onchange="saveAndPreviewProp()" checked> No</label>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between text-xs text-slate-600 bg-slate-50 p-2 rounded">
                                    <span>Basement apartment?</span>
                                    <div class="flex gap-2">
                                        <label><input type="radio" name="prop-bsmt-apt" value="Yes" onchange="saveAndPreviewProp()"> Yes</label>
                                        <label><input type="radio" name="prop-bsmt-apt" value="No" onchange="saveAndPreviewProp()" checked> No</label>
                                    </div>
                                </div>
                            </div>

                            <!-- 8. Systems -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">8. Systems</h3>
                                <input type="text" id="prop-elec" placeholder="Electrical details?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                <input type="text" id="prop-plumb" placeholder="Plumbing details?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                <input type="text" id="prop-roof" placeholder="Roofing details?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                <input type="text" id="prop-heat" placeholder="Heating details?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                            </div>

                            <!-- 9. Security -->
                            <div class="space-y-3">
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">9. Security</h3>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <label class="flex items-center gap-2 bg-slate-50 p-2 rounded"><input type="checkbox" id="prop-burglar" onchange="saveAndPreviewProp()"> Burglar Alarm</label>
                                    <label class="flex items-center gap-2 bg-slate-50 p-2 rounded"><input type="checkbox" id="prop-fire" onchange="saveAndPreviewProp()"> Fire Alarm</label>
                                    <label class="flex items-center gap-2 bg-slate-50 p-2 rounded"><input type="checkbox" id="prop-sprinkler" onchange="saveAndPreviewProp()"> Sprinkler</label>
                                    <label class="flex items-center gap-2 bg-slate-50 p-2 rounded"><input type="checkbox" id="prop-blockwatch" onchange="saveAndPreviewProp()"> Block Watch</label>
                                    <label class="flex items-center gap-2 bg-slate-50 p-2 rounded"><input type="checkbox" id="prop-walled" onchange="saveAndPreviewProp()"> Walled Comm.</label>
                                    <label class="flex items-center gap-2 bg-slate-50 p-2 rounded"><input type="checkbox" id="prop-deadbolts" onchange="saveAndPreviewProp()"> Deadbolts</label>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="prop-smoke-det" placeholder="No. of smoke detectors?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                    <input type="number" id="prop-fire-ext" placeholder="No. of fire extinguishers?" class="w-full h-8 text-xs border-slate-200 rounded bg-white focus:ring-emerald-500 focus:border-emerald-500" oninput="saveAndPreviewProp()">
                                </div>
                            </div>

                            <div class="pt-4">
                                <button type="submit" class="h-11 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold text-sm rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                                    <i class="fa-regular fa-floppy-disk"></i> Save Property Quote
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- RIGHT SIDE: PREVIEW -->
        <div class="bg-slate-50 h-full overflow-y-auto">
            <div class="p-6 max-w-5xl mx-auto">
                <!-- Header with Driver Pages -->
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                        <div class="w-1.5 h-6 bg-indigo-600 rounded-full transition-colors" id="header-bar"></div>
                        <span id="preview-title">Auto Preview</span>
                    </h1>
                </div>

                <!-- Driver Pages Navigation -->
                <div class="mb-6 flex flex-wrap gap-2" id="driver-pages-nav">
                    <button class="driver-page-btn active h-9 px-4 bg-indigo-600 text-white text-xs font-semibold rounded-lg shadow-sm hover:bg-indigo-700 transition-all" onclick="switchDriverPage(1)" data-driver="1">
                        <i class="fa-solid fa-user mr-2"></i>Driver 1
                    </button>
                </div>
                
                <!-- OLD Driver Select (kept for compatibility, will be hidden in multi-driver) -->
                <div class="flex items-center justify-between mb-8 hidden" id="old-driver-select">
                    <!-- Only show driver select in Auto Mode -->
                    <div class="relative group flex-1" id="driver-select-container">
                        <select id="driverSelect" onchange="switchDriverView(this.value)" 
                            class="h-10 appearance-none bg-white border border-slate-200 text-slate-700 font-semibold pl-4 pr-10 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 hover:border-indigo-300 transition-all text-sm cursor-pointer min-w-[220px]">
                            <option value="1">Driver 1 (Applicant)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400 group-hover:text-indigo-500 transition-colors">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>

                    <!-- Property Select in Property Mode -->
                    <div class="relative group hidden" id="property-select-container">
                        <select id="propertySelect" onchange="switchPropertyView(this.value)" 
                            class="h-10 appearance-none bg-white border border-slate-200 text-slate-700 font-semibold pl-4 pr-10 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 hover:border-emerald-300 transition-all text-sm cursor-pointer min-w-[220px]">
                            <!-- JS Populates this -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400 group-hover:text-emerald-500 transition-colors">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="flex gap-1 mb-8 bg-white p-1.5 rounded-xl shadow-sm border border-slate-200 w-fit">
                    <button class="preview-tab h-8 px-5 rounded-lg text-xs font-semibold text-slate-500 hover:text-slate-700 hover:bg-slate-50 transition-all active-tab flex items-center" onclick="switchTab('preview')">
                        <i class="fa-regular fa-eye mr-2"></i> Quick View
                    </button>
                    <button class="preview-tab h-8 px-5 rounded-lg text-xs font-semibold text-slate-500 hover:text-slate-700 hover:bg-slate-50 transition-all flex items-center" onclick="switchTab('copy')">
                        <i class="fa-regular fa-copy mr-2"></i> Copy Info
                    </button>
                    <button class="preview-tab h-8 px-5 rounded-lg text-xs font-semibold text-slate-500 hover:text-slate-700 hover:bg-slate-50 transition-all flex items-center" onclick="switchTab('property')">
                        <i class="fa-solid fa-house mr-2"></i> Property View
                    </button>
                </div>
                
                <!-- CONTENT: QUICK PREVIEW (AUTO) -->
                <div id="tab-preview" class="tab-content block space-y-6">
                    <!-- ... existing content ... -->
                    
                    <!-- Driver Info -->
                    <div class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden">
                        <div class="bg-slate-50/80 px-5 py-3 border-b border-slate-100 flex items-center justify-between">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Driver Details</span>
                            <i class="fa-regular fa-id-card text-slate-300"></i>
                        </div>
                        <div class="p-6 grid grid-cols-2 gap-x-8 gap-y-5">
                            <div>
                                <div class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Name</div>
                                <div id="prev-name" class="text-sm font-semibold text-slate-800 truncate tracking-tight">—</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-semibold text-slate-400 uppercase mb-1">DLN</div>
                                <div id="prev-dln" class="text-sm font-semibold text-slate-800 font-mono tracking-tight">—</div>
                            </div>
                            <div class="col-span-2">
                                <div class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Demographics</div>
                                <div id="prev-demo" class="text-sm font-medium text-slate-700">—</div>
                            </div>
                            <div class="col-span-2">
                                <div class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Address</div>
                                <div id="prev-address" class="text-sm font-medium text-slate-700">—</div>
                            </div>
                        </div>
                    </div>

                    <!-- History Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- History -->
                        <div class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden">
                            <div class="bg-slate-50/80 px-5 py-3 border-b border-slate-100 flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">History (3y / 6y)</span>
                                <i class="fa-solid fa-clock-rotate-left text-slate-300"></i>
                            </div>
                            <div class="p-5 grid grid-cols-2 gap-4">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase">Non-Pay (3y)</div>
                                    <div id="prev-nonpay" class="text-lg font-bold text-slate-800 mt-1">—</div>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase">Claims (6y)</div>
                                    <div id="prev-claims" class="text-lg font-bold text-slate-800 mt-1">—</div>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase">1st Party (6y)</div>
                                    <div id="prev-firstparty" class="text-lg font-bold text-slate-800 mt-1">—</div>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase">Gaps (6y)</div>
                                    <div id="prev-gaps" class="text-lg font-bold text-slate-800 mt-1">—</div>
                                </div>
                            </div>
                        </div>

                        <!-- Current Policy -->
                        <div class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden">
                            <div class="bg-slate-50/80 px-5 py-3 border-b border-slate-100 flex items-center justify-between">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Current Policy</span>
                                <i class="fa-solid fa-file-contract text-slate-300"></i>
                            </div>
                            <div class="p-5 space-y-5">
                                <div class="flex justify-between items-end border-b border-slate-50 pb-3">
                                    <div>
                                        <div class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Company</div>
                                        <div id="prev-company" class="text-sm font-bold text-slate-800">—</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Expiry In</div>
                                        <div id="prev-days-expiry" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">—</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Vehicles (<span id="prev-vehicles-count" class="font-bold text-slate-700">0</span>)</div>
                                        <div id="prev-vehicles-list" class="text-xs text-slate-500 italic">—</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Operators (<span id="prev-operators-count" class="font-bold text-slate-700">0</span>)</div>
                                        <div id="prev-operators-list" class="text-xs text-slate-500 italic">—</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle & Contact -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Vehicle -->
                        <div class="bg-white rounded-xl shadow-card border border-slate-100 p-6">
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-5 flex items-center gap-2">
                                <i class="fa-solid fa-car-side text-slate-300"></i> Vehicle Info
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm border-b border-dashed border-slate-100 pb-2">
                                    <span class="text-slate-500 font-medium">Ownership</span>
                                    <span id="prev-ownership" class="text-slate-800 font-semibold">Owned</span>
                                </div>
                                <div class="flex justify-between text-sm border-b border-dashed border-slate-100 pb-2">
                                    <span class="text-slate-500 font-medium">Use</span>
                                    <span id="prev-use" class="text-slate-800 font-semibold">Pleasure</span>
                                </div>
                                <div class="flex justify-between text-sm border-b border-dashed border-slate-100 pb-2">
                                    <span class="text-slate-500 font-medium">Annual KM</span>
                                    <span id="prev-km" class="text-slate-800 font-semibold">15,000</span>
                                </div>
                                <div class="flex justify-between text-sm border-b border-dashed border-slate-100 pb-2">
                                    <span class="text-slate-500 font-medium">Winter Tires</span>
                                    <span id="prev-winter" class="text-slate-800 font-semibold">Yes</span>
                                </div>
                                <div class="flex justify-between text-sm pt-1">
                                    <span class="text-slate-500 font-medium">Anti-Theft</span>
                                    <span id="prev-antitheft" class="text-slate-800 font-semibold">No</span>
                                </div>
                            </div>
                        </div>

                        <!-- Contact -->
                        <div class="bg-white rounded-xl shadow-card border border-slate-100 p-6">
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-5 flex items-center gap-2">
                                <i class="fa-solid fa-address-book text-slate-300"></i> Contact Info
                            </h3>
                            <div class="space-y-5">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-400">
                                        <i class="fa-solid fa-phone text-sm"></i>
                                    </div>
                                    <div>
                                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-0.5">Phone</div>
                                        <div id="prev-phone" class="text-sm font-semibold text-slate-800">—</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-400">
                                        <i class="fa-solid fa-envelope text-sm"></i>
                                    </div>
                                    <div>
                                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-0.5">Email</div>
                                        <div id="prev-email" class="text-sm font-semibold text-slate-800">—</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MVR Info -->
                    <div class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden">
                        <div class="bg-slate-50/80 px-5 py-3 border-b border-slate-100 flex items-center justify-between">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">MVR Info</span>
                            <i class="fa-solid fa-circle-exclamation text-slate-300"></i>
                        </div>
                        <div class="p-6">
                            <!-- Top 4 Key Metrics -->
                            <div class="grid grid-cols-4 gap-4 mb-6">
                                <div class="text-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Convictions</div>
                                    <div id="mvr-convictions" class="text-sm font-bold text-slate-800">—</div>
                                </div>
                                <div class="text-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Birth Date</div>
                                    <div id="mvr-birthdate" class="text-sm font-bold text-slate-800">—</div>
                                </div>
                                <div class="text-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Expiry</div>
                                    <div id="mvr-expiry" class="text-sm font-bold text-slate-800">—</div>
                                </div>
                                <div class="text-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Exp. (Yrs)</div>
                                    <div id="mvr-experience" class="text-sm font-bold text-slate-800">—</div>
                                </div>
                            </div>

                            <!-- Convictions List -->
                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-100">
                                <div class="text-[10px] font-bold text-slate-400 uppercase mb-2">Convictions List</div>
                                <div id="mvr-convictions-list" class="text-xs text-slate-500 italic text-center py-2">—</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONTENT: COPY INFO (AUTO) -->
                <div id="tab-copy" class="tab-content hidden space-y-6">
                    <!-- General Details Grid -->
                    <div class="bg-white rounded-xl shadow-card border border-slate-100 p-6">
                        <h3 class="text-xs font-bold text-indigo-900 uppercase tracking-widest mb-6 pb-2 border-b border-indigo-50 flex items-center gap-2">
                            <i class="fa-solid fa-user-tag text-indigo-400"></i> General Details
                        </h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-5">
                            
                            <!-- Name -->
                            <div class="flex items-center gap-3">
                                <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">Driver Name</label>
                                <input type="text" id="copy-name" value="—" readonly 
                                    class="h-9 flex-1 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                <button onclick="copyToClipboard('copy-name', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all flex-shrink-0">
                                    <i class="fa-regular fa-clipboard"></i>
                                </button>
                            </div>

                            <!-- DOB -->
                            <div class="flex items-center gap-3">
                                <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">Date of Birth</label>
                                <input type="text" id="copy-dob" placeholder="mm/dd/yyyy" maxlength="10" oninput="autoFormatDate(event)" 
                                    class="h-9 flex-1 bg-white border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-300">
                                <button onclick="copyToClipboard('copy-dob', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all flex-shrink-0">
                                    <i class="fa-regular fa-clipboard"></i>
                                </button>
                            </div>

                            <!-- Phone -->
                            <div class="flex items-center gap-3">
                                <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">Phone</label>
                                <input type="text" id="copy-phone" value="—" 
                                    class="h-9 flex-1 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                <button onclick="copyToClipboard('copy-phone', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all flex-shrink-0">
                                    <i class="fa-regular fa-clipboard"></i>
                                </button>
                            </div>

                            <!-- Email -->
                            <div class="flex items-center gap-3">
                                <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">Email</label>
                                <input type="text" id="copy-email" value="—" 
                                    class="h-9 flex-1 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                <button onclick="copyToClipboard('copy-email', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all flex-shrink-0">
                                    <i class="fa-regular fa-clipboard"></i>
                                </button>
                            </div>

                            <!-- Licence -->
                            <div class="flex items-center gap-3">
                                <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">Licence #</label>
                                <input type="text" id="copy-license" value="—" readonly 
                                    class="h-9 flex-1 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                <button onclick="copyToClipboard('copy-license', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all flex-shrink-0">
                                    <i class="fa-regular fa-clipboard"></i>
                                </button>
                            </div>

                            <!-- Annual KM -->
                            <div class="flex items-center gap-3">
                                <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">Annual KM</label>
                                <input type="text" id="copy-annual-km" value="—" readonly 
                                    class="h-9 flex-1 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                <button onclick="copyToClipboard('copy-annual-km', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all flex-shrink-0">
                                    <i class="fa-regular fa-clipboard"></i>
                                </button>
                            </div>

                            <!-- Address (Span 2 col for input) -->
                            <div class="flex items-center gap-3 lg:col-span-2">
                                <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">Address</label>
                                <input type="text" id="copy-address" value="—" readonly 
                                    class="h-9 flex-1 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                <button onclick="copyToClipboard('copy-address', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all flex-shrink-0">
                                    <i class="fa-regular fa-clipboard"></i>
                                </button>
                            </div>

                            <!-- Vehicle Condition (Span 2) -->
                            <div class="flex items-center gap-3 lg:col-span-2">
                                <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">Veh. Condition</label>
                                <input type="text" id="copy-vehicle-condition" value="—" readonly 
                                    class="h-9 flex-1 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                <button onclick="copyToClipboard('copy-vehicle-condition', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all flex-shrink-0">
                                    <i class="fa-regular fa-clipboard"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Combinations -->
                    <div id="combinations-section" class="bg-white rounded-xl shadow-card border border-slate-100 p-6">
                        <h3 class="text-xs font-bold text-indigo-900 uppercase tracking-widest mb-6 pb-2 border-b border-indigo-50 flex items-center gap-2">
                            <i class="fa-solid fa-layer-group text-indigo-400"></i> Combinations
                        </h3>
                        
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                            
                            <!-- LEFT COLUMN: 1 MAX (HIDDEN) -->
                            <div class="hidden">
                                <div class="mb-4 flex items-center gap-3">
                                    <div class="h-px bg-slate-100 flex-1"></div>
                                    <span class="text-[10px] font-bold text-slate-400 uppercase bg-slate-50/50 px-3 py-1 rounded-full border border-slate-200">1 Max</span>
                                    <div class="h-px bg-slate-100 flex-1"></div>
                                </div>

                                <div class="grid grid-cols-[60px_1fr_36px] gap-3 items-center">
                                    <label class="text-[11px] font-semibold text-slate-500 text-right">G Date</label>
                                    <input type="text" id="copy-g-date" placeholder="mm/dd/yyyy" readonly class="h-9 w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                    <button onclick="copyToClipboard('copy-g-date', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all"><i class="fa-regular fa-clipboard"></i></button>

                                    <label class="text-[11px] font-semibold text-slate-500 text-right">G2 Date</label>
                                    <input type="text" id="copy-g2-date" placeholder="mm/dd/yyyy" readonly class="h-9 w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                    <button onclick="copyToClipboard('copy-g2-date', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all"><i class="fa-regular fa-clipboard"></i></button>

                                    <label class="text-[11px] font-semibold text-slate-500 text-right">G1 Date</label>
                                    <input type="text" id="copy-g1-date" placeholder="mm/dd/yyyy" readonly class="h-9 w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                    <button onclick="copyToClipboard('copy-g1-date', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all"><i class="fa-regular fa-clipboard"></i></button>
                                </div>
                            </div>

                            <!-- RIGHT COLUMN: MANUAL CALCULATION -->
                            <div class="xl:col-span-2">
                                <div class="flex items-center justify-between bg-indigo-50 px-4 py-2.5 rounded-t-xl border-b border-indigo-100">
                                    <span class="text-[11px] font-bold text-indigo-900 uppercase tracking-wide flex items-center gap-2">
                                        <i class="fa-solid fa-calculator text-indigo-400"></i> Manual
                                    </span>
                                    <span id="manual-gap-display" class="text-[10px] font-bold text-indigo-600 bg-white px-2 py-0.5 rounded shadow-sm border border-indigo-100">Gap: --</span>
                                </div>
                                <div class="bg-white border border-t-0 border-slate-200 rounded-b-xl p-4 grid grid-cols-2 gap-3 mb-4 shadow-sm">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">First Ins Date</label>
                                        <input type="text" id="manual-first-ins" placeholder="mm/dd/yyyy" maxlength="10" oninput="autoFormatDate(event); calculateManualDates()"
                                            class="h-9 w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg px-3 font-mono focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Issue Date</label>
                                        <input type="text" id="manual-issue-date" placeholder="mm/dd/yyyy" maxlength="10" oninput="autoFormatDate(event); calculateManualDates()"
                                            class="h-9 w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg px-3 font-mono focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all">
                                    </div>
                                </div>

                                <div class="grid grid-cols-[50px_auto_1fr_36px] gap-2 items-center">
                                    <!-- Manual G Row -->
                                    <label class="text-[11px] font-semibold text-slate-500 text-right">G Date</label>
                                    <div class="flex items-center bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden h-9 w-20">
                                        <button type="button" onclick="adjustOffset('manual-g-offset', -1)" class="w-6 h-full flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-50 border-r border-slate-100 transition-colors bg-slate-50/50">
                                            <i class="fa-solid fa-minus text-[9px]"></i>
                                        </button>
                                        <input type="number" id="manual-g-offset" step="1" placeholder="0" oninput="calculateManualDates()" 
                                            class="w-full h-full text-center text-slate-700 font-bold text-xs outline-none border-none bg-transparent appearance-none p-0">
                                        <button type="button" onclick="adjustOffset('manual-g-offset', 1)" class="w-6 h-full flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-50 border-l border-slate-100 transition-colors bg-slate-50/50">
                                            <i class="fa-solid fa-plus text-[9px]"></i>
                                        </button>
                                    </div>
                                    <input type="text" id="copy-manual-g-date" readonly class="h-9 w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                    <button onclick="copyToClipboard('copy-manual-g-date', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all"><i class="fa-regular fa-clipboard"></i></button>

                                    <!-- Manual G2 Row -->
                                    <label class="text-[11px] font-semibold text-slate-500 text-right">G2 Date</label>
                                    <div class="flex items-center bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden h-9 w-20">
                                        <button type="button" onclick="adjustOffset('manual-g2-offset', -1)" class="w-6 h-full flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-50 border-r border-slate-100 transition-colors bg-slate-50/50">
                                            <i class="fa-solid fa-minus text-[9px]"></i>
                                        </button>
                                        <input type="number" id="manual-g2-offset" step="1" placeholder="0" oninput="calculateManualDates()" 
                                            class="w-full h-full text-center text-slate-700 font-bold text-xs outline-none border-none bg-transparent appearance-none p-0">
                                        <button type="button" onclick="adjustOffset('manual-g2-offset', 1)" class="w-6 h-full flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-50 border-l border-slate-100 transition-colors bg-slate-50/50">
                                            <i class="fa-solid fa-plus text-[9px]"></i>
                                        </button>
                                    </div>
                                    <input type="text" id="copy-manual-g2-date" readonly class="h-9 w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                    <button onclick="copyToClipboard('copy-manual-g2-date', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all"><i class="fa-regular fa-clipboard"></i></button>

                                    <!-- Manual G1 Row -->
                                    <label class="text-[11px] font-semibold text-slate-500 text-right">G1 Date</label>
                                    <div class="flex items-center bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden h-9 w-20">
                                        <button type="button" onclick="adjustOffset('manual-g1-offset', -1)" class="w-6 h-full flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-50 border-r border-slate-100 transition-colors bg-slate-50/50">
                                            <i class="fa-solid fa-minus text-[9px]"></i>
                                        </button>
                                        <input type="number" id="manual-g1-offset" step="1" placeholder="0" oninput="calculateManualDates()" 
                                            class="w-full h-full text-center text-slate-700 font-bold text-xs outline-none border-none bg-transparent appearance-none p-0">
                                        <button type="button" onclick="adjustOffset('manual-g1-offset', 1)" class="w-6 h-full flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-50 border-l border-slate-100 transition-colors bg-slate-50/50">
                                            <i class="fa-solid fa-plus text-[9px]"></i>
                                        </button>
                                    </div>
                                    <input type="text" id="copy-manual-g1-date" readonly class="h-9 w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                                    <button onclick="copyToClipboard('copy-manual-g1-date', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all"><i class="fa-regular fa-clipboard"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insurance Details -->
                    <div class="bg-white rounded-xl shadow-card border border-slate-100 p-6">
                        <h3 class="text-xs font-bold text-indigo-900 uppercase tracking-widest mb-6 pb-2 border-b border-indigo-50 flex items-center gap-2">
                            <i class="fa-solid fa-shield-halved text-indigo-400"></i> Insurance Details
                        </h3>
                        <div class="grid grid-cols-[100px_1fr_36px] gap-x-8 gap-y-5 items-center">
                            <label class="text-[11px] font-semibold text-slate-500 text-right truncate">Cont Ins</label>
                            <input type="text" id="copy-cont-ins" value="—" readonly class="h-9 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                            <button onclick="copyToClipboard('copy-cont-ins', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all"><i class="fa-regular fa-clipboard"></i></button>

                            <label class="text-[11px] font-semibold text-slate-500 text-right truncate">Company</label>
                            <input type="text" id="copy-company-insured" value="—" readonly class="h-9 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                            <button onclick="copyToClipboard('copy-company-insured', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all"><i class="fa-regular fa-clipboard"></i></button>
                        </div>
                    </div>
                </div>

                <!-- CONTENT: PROPERTY VIEW -->
                <div id="tab-property" class="tab-content hidden space-y-6">
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6" id="property-preview-grid">
                        <!-- JS will populate this -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let driverCount = 1;
        let driverDocTypes = { 1: 'dash' };
        let currentDisplayDriver = 1;  // Track which driver's data is being displayed
        
        // Store parsed DASH and MVR data for combination calculation
        let parsedDASHData = {};  // { driverNum: dash_data }
        let parsedMVRData = {};   // { driverNum: mvr_data }
        let parsedGDates = {};    // { driverNum: { g_date, g2_date, g1_date, message } }
        
        // --- CUSTOMER SEARCH LOGIC ---
        
        // Autocomplete suggestions container
        let allLeads = [];
        
        // Fetch all leads on page load
        async function loadAllLeads() {
            try {
                const response = await fetch('/api/leads?page_size=1000');
                const data = await response.json();
                if (data.success && data.leads) {
                    allLeads = data.leads;
                    console.log('[SEARCH] Loaded', allLeads.length, 'leads from API');
                }
            } catch (e) {
                console.error('[SEARCH] Error loading leads:', e);
            }
        }
        
        // Show autocomplete suggestions as user types
        function showSearchSuggestions() {
            const input = document.getElementById('customer-search-input');
            const query = input.value.trim().toLowerCase();
            
            if (query.length === 0) {
                hideSuggestions();
                return;
            }
            
            // Filter leads matching query
            const matches = allLeads.filter(lead => {
                const name = (lead.full_name || '').toLowerCase();
                const phone = (lead.phone || '').toLowerCase();
                return name.includes(query) || phone.includes(query);
            });
            
            if (matches.length === 0) {
                hideSuggestions();
                return;
            }
            
            // Show suggestions
            let suggestionsHTML = '<div class="absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto">';
            
            matches.slice(0, 10).forEach((lead, idx) => {
                suggestionsHTML += `
                    <div class="px-4 py-3 border-b border-slate-100 last:border-b-0 hover:bg-slate-50 cursor-pointer" 
                         onclick="selectLead('${lead.full_name}', '${lead.phone}', '${lead.id}', '${lead.email}')">
                        <div class="text-sm font-semibold text-slate-700">${lead.full_name}</div>
                        <div class="text-xs text-slate-500">${lead.phone} | ${lead.email}</div>
                    </div>
                `;
            });
            
            suggestionsHTML += '</div>';
            
            // Create or update suggestions container
            let suggestionsContainer = document.getElementById('search-suggestions');
            if (!suggestionsContainer) {
                suggestionsContainer = document.createElement('div');
                suggestionsContainer.id = 'search-suggestions';
                suggestionsContainer.style.position = 'relative';
                input.parentElement.appendChild(suggestionsContainer);
            }
            
            suggestionsContainer.innerHTML = suggestionsHTML;
            console.log('[SEARCH] Showing', matches.length, 'suggestions');
        }
        
        function hideSuggestions() {
            const container = document.getElementById('search-suggestions');
            if (container) {
                container.innerHTML = '';
            }
        }
        
        function selectLead(name, phone, id, email) {
            console.log('[SEARCH] Selected:', name, phone, email);
            document.getElementById('customer-search-input').value = name;
            hideSuggestions();
            performSearch(name, phone, id, email);
        }
        
        async function performSearch(leadName, leadPhone, leadId, leadEmail) {
            const query = leadName || document.getElementById('customer-search-input').value;
            if(query.trim() === "") return;

            console.log('[SEARCH] Performing search for:', query, 'phone:', leadPhone, 'email:', leadEmail);
            
            // Find the full lead data
            let selectedLead = null;
            if (leadId) {
                selectedLead = allLeads.find(l => l.id == leadId);
            } else {
                // Search for the lead
                const queryLower = query.toLowerCase();
                selectedLead = allLeads.find(l => 
                    (l.full_name || '').toLowerCase().includes(queryLower) ||
                    (l.phone || '').toLowerCase().includes(queryLower)
                );
            }
            
            // If found in leads, use real data
            if (selectedLead) {
                console.log('[SEARCH] Found lead:', selectedLead);
                document.getElementById('customer-search-block').classList.add('hidden');
                document.getElementById('customer-selected-block').classList.remove('hidden');
                
                // Show Workflow
                const wf = document.getElementById('workflow-container');
                wf.classList.remove('hidden', 'opacity-50', 'pointer-events-none');
                
                // Fill with real data
                document.getElementById('selected-customer-name').textContent = selectedLead.full_name || 'Unknown';
                document.getElementById('selected-customer-phone').textContent = selectedLead.phone || 'N/A';
                document.getElementById('selected-customer-email').textContent = selectedLead.email || 'N/A';
                
                // AUTO-POPULATE PHONE AND EMAIL IN MANUAL ENTRY SECTION (Contact Info)
                document.getElementById('phone').value = selectedLead.phone || '';
                document.getElementById('email').value = selectedLead.email || '';
                
                // AUTO-POPULATE PHONE AND EMAIL IN QUICK VIEW CONTACT INFO
                document.getElementById('prev-phone').textContent = selectedLead.phone || '—';
                document.getElementById('prev-email').textContent = selectedLead.email || '—';
                
                // AUTO-POPULATE PREMIUM, POTENTIAL STATUS, AND RENEWAL DATE FROM LEAD ROW
                if (selectedLead.premium) {
                    document.getElementById('premium').value = selectedLead.premium;
                    console.log('[SEARCH] Auto-filled premium: ' + selectedLead.premium);
                }
                if (selectedLead.potential_status) {
                    document.getElementById('potential-status').value = selectedLead.potential_status;
                    console.log('[SEARCH] Auto-filled potential status: ' + selectedLead.potential_status);
                }
                if (selectedLead.renewal_date) {
                    document.getElementById('renewal-date').value = selectedLead.renewal_date;
                    console.log('[SEARCH] Auto-filled renewal date: ' + selectedLead.renewal_date);
                }
                document.getElementById('prev-email').textContent = selectedLead.email || '—';
                
                // AUTO-POPULATE PHONE AND EMAIL IN COPY INFO TAB
                document.getElementById('copy-phone').value = selectedLead.phone || '—';
                document.getElementById('copy-email').value = selectedLead.email || '—';
                
                console.log('[SEARCH] ✓ Lead loaded:', selectedLead.full_name, 'phone:', selectedLead.phone, 'email:', selectedLead.email);
            } else {
                console.log('[SEARCH] Lead not found, showing demo data');
                // Fallback to showing what user typed
                document.getElementById('customer-search-block').classList.add('hidden');
                document.getElementById('customer-selected-block').classList.remove('hidden');
                
                const wf = document.getElementById('workflow-container');
                wf.classList.remove('hidden', 'opacity-50', 'pointer-events-none');
                
                document.getElementById('selected-customer-name').textContent = query;
                document.getElementById('selected-customer-phone').textContent = "Not in system";
                document.getElementById('selected-customer-email').textContent = "N/A";
                
                // Clear phone and email if lead not found
                document.getElementById('copy-phone').value = '—';
                document.getElementById('copy-email').value = '—';
            }
        }

        function clearCustomer() {
            document.getElementById('customer-search-input').value = "";
            document.getElementById('customer-search-block').classList.remove('hidden');
            document.getElementById('customer-selected-block').classList.add('hidden');
            hideSuggestions();
            
            // Hide/Disable Workflow
            const wf = document.getElementById('workflow-container');
            wf.classList.add('opacity-50', 'pointer-events-none');
        }

        function goBackToMeta() {
            try {
                // Navigate back to the leads dashboard immediately
                window.location.href = '/';
            } catch (error) {
                console.error('Error going back:', error);
                // Fallback: try history back
                window.history.back();
            }
        }

        // --- PROPERTY MULTI-INSTANCE LOGIC ---
        
        // Store properties data in memory
        let propertiesData = {
            1: { type: 'Primary Home', address: '', city: '', postal: '', purchased: '', insured: '', ownerOcc: 'Yes', mortgage: 'Yes', lender: '', mortCount: '', built: '', storeys: '', units: '', families: '', fullBaths: '', halfBaths: '', livingArea: '', bsmtArea: '', bsmtFin: '', inlaw: 'No', bsmtApt: 'No', elec: '', plumb: '', roof: '', heat: '', burglar: false, fire: false, sprinkler: false, blockwatch: false, walled: false, deadbolts: false, smoke: '', ext: '' }
        };
        let activePropId = 1; // ID of property currently being EDITED (Left side)
        let viewPropId = 1;   // ID of property currently being VIEWED (Right side)
        let propertyCounter = 1; // Auto-increment ID

        function renderPropertyTabs() {
            const container = document.getElementById('property-tabs-container');
            container.innerHTML = '';
            
            Object.keys(propertiesData).forEach(id => {
                const prop = propertiesData[id];
                const isActive = parseInt(id) === activePropId;
                const activeClass = isActive ? 'bg-emerald-600 text-white border-emerald-600 shadow-md' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 hover:text-slate-700';
                
                const btn = document.createElement('button');
                btn.className = `h-7 px-3 rounded-md text-[10px] font-bold border transition-all ${activeClass}`;
                btn.textContent = `${prop.type} (${id})`;
                btn.type = 'button'; // Prevent form submit
                btn.onclick = () => switchPropertyEdit(parseInt(id));
                container.appendChild(btn);
            });
            
            // Update Right Side Dropdown
            const dropdown = document.getElementById('propertySelect');
            dropdown.innerHTML = '';
            Object.keys(propertiesData).forEach(id => {
                const prop = propertiesData[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `Property ${id} - ${prop.type}`;
                if(parseInt(id) === viewPropId) option.selected = true;
                dropdown.appendChild(option);
            });
        }

        function addNewProperty() {
            propertyCounter++;
            const newId = propertyCounter;
            // Default new property template
            propertiesData[newId] = { 
                type: 'Primary Home', 
                address: '', city: '', postal: '', purchased: '', insured: '', ownerOcc: 'Yes', mortgage: 'No', lender: '', mortCount: '', built: '', storeys: '', units: '', families: '', fullBaths: '', halfBaths: '', livingArea: '', bsmtArea: '', bsmtFin: '', inlaw: 'No', bsmtApt: 'No', elec: '', plumb: '', roof: '', heat: '', burglar: false, fire: false, sprinkler: false, blockwatch: false, walled: false, deadbolts: false, smoke: '', ext: '' 
            };
            
            // Switch to it immediately
            switchPropertyEdit(newId);
        }

        function deleteActiveProperty() {
            const keys = Object.keys(propertiesData);
            if (keys.length <= 1) {
                alert("You cannot delete the only property. Add another one first or clear the form.");
                return;
            }

            if (!confirm(`Are you sure you want to remove Property ${activePropId}?`)) return;

            // Delete current
            delete propertiesData[activePropId];

            // Switch to the first available property
            const remainingKeys = Object.keys(propertiesData);
            const newActiveId = parseInt(remainingKeys[0]); // Default to first available
            
            // Also update view ID if we deleted the one being viewed
            if (viewPropId === activePropId) {
                viewPropId = newActiveId;
            }

            switchPropertyEdit(newActiveId);
            
            // Force view update if needed
            if(document.getElementById('propertySelect')) {
                 document.getElementById('propertySelect').value = viewPropId;
                 updatePropertyPreview();
            }
        }

        function switchPropertyEdit(id) {
            // 1. We don't need to "save" the previous inputs because 'saveAndPreviewProp' runs on every keystroke/change.
            //    So the propertiesData object is always up to date.
            
            // 2. Set new active ID
            activePropId = id;
            
            // 3. Load data into form inputs
            const data = propertiesData[id];
            
            // Set fields
            document.getElementById('prop-type').value = data.type;
            document.getElementById('prop-address').value = data.address || '';
            document.getElementById('prop-city').value = data.city || '';
            document.getElementById('prop-postal').value = data.postal || '';
            document.getElementById('prop-purchased').value = data.purchased || '';
            document.getElementById('prop-first-insured').value = data.insured || '';
            
            // Radios
            setRadio('prop-owner-occ', data.ownerOcc);
            setRadio('prop-mortgage', data.mortgage);
            setRadio('prop-inlaw', data.inlaw);
            setRadio('prop-bsmt-apt', data.bsmtApt);
            
            document.getElementById('prop-lender').value = data.lender || '';
            document.getElementById('prop-mortgage-count').value = data.mortCount || '';
            document.getElementById('prop-year-built').value = data.built || '';
            document.getElementById('prop-storeys').value = data.storeys || '';
            document.getElementById('prop-units').value = data.units || '';
            document.getElementById('prop-families').value = data.families || '';
            document.getElementById('prop-full-baths').value = data.fullBaths || '';
            document.getElementById('prop-half-baths').value = data.halfBaths || '';
            document.getElementById('prop-living-area').value = data.livingArea || '';
            document.getElementById('prop-basement-area').value = data.bsmtArea || '';
            document.getElementById('prop-basement-fin').value = data.bsmtFin || '';
            document.getElementById('prop-elec').value = data.elec || '';
            document.getElementById('prop-plumb').value = data.plumb || '';
            document.getElementById('prop-roof').value = data.roof || '';
            document.getElementById('prop-heat').value = data.heat || '';
            
            // Checkboxes
            document.getElementById('prop-burglar').checked = data.burglar;
            document.getElementById('prop-fire').checked = data.fire;
            document.getElementById('prop-sprinkler').checked = data.sprinkler;
            document.getElementById('prop-blockwatch').checked = data.blockwatch;
            document.getElementById('prop-walled').checked = data.walled;
            document.getElementById('prop-deadbolts').checked = data.deadbolts;
            
            document.getElementById('prop-smoke-det').value = data.smoke || '';
            document.getElementById('prop-fire-ext').value = data.ext || '';

            // 4. Re-render tabs to update active state styling
            renderPropertyTabs();
        }

        function setRadio(name, value) {
            const radios = document.getElementsByName(name);
            for(let r of radios) {
                if(r.value === value) r.checked = true;
            }
        }

        // Called on Input Change in Left Form
        function saveAndPreviewProp() {
            // Save to memory
            const data = propertiesData[activePropId];
            data.type = document.getElementById('prop-type').value; // Just in case
            data.address = document.getElementById('prop-address').value;
            data.city = document.getElementById('prop-city').value;
            data.postal = document.getElementById('prop-postal').value;
            data.purchased = document.getElementById('prop-purchased').value;
            data.insured = document.getElementById('prop-first-insured').value;
            data.ownerOcc = document.querySelector('input[name="prop-owner-occ"]:checked')?.value || 'No';
            data.mortgage = document.querySelector('input[name="prop-mortgage"]:checked')?.value || 'No';
            data.lender = document.getElementById('prop-lender').value;
            data.mortCount = document.getElementById('prop-mortgage-count').value;
            data.built = document.getElementById('prop-year-built').value;
            data.storeys = document.getElementById('prop-storeys').value;
            data.units = document.getElementById('prop-units').value;
            data.families = document.getElementById('prop-families').value;
            data.fullBaths = document.getElementById('prop-full-baths').value;
            data.halfBaths = document.getElementById('prop-half-baths').value;
            data.livingArea = document.getElementById('prop-living-area').value;
            data.bsmtArea = document.getElementById('prop-basement-area').value;
            data.bsmtFin = document.getElementById('prop-basement-fin').value;
            data.inlaw = document.querySelector('input[name="prop-inlaw"]:checked')?.value || 'No';
            data.bsmtApt = document.querySelector('input[name="prop-bsmt-apt"]:checked')?.value || 'No';
            data.elec = document.getElementById('prop-elec').value;
            data.plumb = document.getElementById('prop-plumb').value;
            data.roof = document.getElementById('prop-roof').value;
            data.heat = document.getElementById('prop-heat').value;
            data.burglar = document.getElementById('prop-burglar').checked;
            data.fire = document.getElementById('prop-fire').checked;
            data.sprinkler = document.getElementById('prop-sprinkler').checked;
            data.blockwatch = document.getElementById('prop-blockwatch').checked;
            data.walled = document.getElementById('prop-walled').checked;
            data.deadbolts = document.getElementById('prop-deadbolts').checked;
            data.smoke = document.getElementById('prop-smoke-det').value;
            data.ext = document.getElementById('prop-fire-ext').value;

            // If we are currently Viewing the property we are Editing, update preview live
            if (activePropId === viewPropId) {
                updatePropertyPreview();
            }
            
            // Also refresh tabs labels in case Type changed
            renderPropertyTabs(); 
        }

        // Called when Property Type Dropdown changes on Left Form
        function updatePropertyType() {
            const type = document.getElementById('prop-type').value;
            propertiesData[activePropId].type = type;
            renderPropertyTabs();
        }

        // Called when Right Side Dropdown changes
        function switchPropertyView(id) {
            viewPropId = parseInt(id);
            updatePropertyPreview();
        }

        // --- END PROPERTY MULTI-INSTANCE LOGIC ---

        // Auto-format date inputs
        function autoFormatDate(e) {
            var input = e.target;
            var value = input.value;
            var numbers = value.replace(/\D/g, ''); 
            if (numbers.length > 8) numbers = numbers.substr(0, 8);
            var formatted = '';
            if (numbers.length > 0) {
                formatted += numbers.substr(0, 2); 
                if (numbers.length > 2) {
                    formatted += '/' + numbers.substr(2, 2); 
                    if (numbers.length > 4) {
                        formatted += '/' + numbers.substr(4, 4); 
                    }
                }
            }
            if (input.value !== formatted) input.value = formatted;
        }

        function parseDateStr(str) {
            if(!str || str.length < 10) return null;
            const parts = str.split('/');
            if(parts.length !== 3) return null;
            const mm = parseInt(parts[0], 10) - 1;
            const dd = parseInt(parts[1], 10);
            const yyyy = parseInt(parts[2], 10);
            const date = new Date(yyyy, mm, dd);
            if (isNaN(date.getTime())) return null;
            return date;
        }

        function adjustOffset(inputId, delta) {
            const input = document.getElementById(inputId);
            let val = parseInt(input.value) || 0;  // Use parseInt for whole years
            val += delta;
            if (val < 0) val = 0;  // Prevent negative years
            input.value = val.toString();  // Store as whole number
            calculateManualDates();
        }

        function calculateManualDates() {
            const firstInsStr = document.getElementById('manual-first-ins').value;
            const issueDateStr = document.getElementById('manual-issue-date').value;
            
            console.log('[CALC] First Insurance Date:', firstInsStr);
            console.log('[CALC] Issue Date:', issueDateStr);
            
            // Display total months gap
            const d1 = parseDateStr(firstInsStr);
            const d2 = parseDateStr(issueDateStr);
            if (d1 && d2) {
                let months = (d2.getFullYear() - d1.getFullYear()) * 12;
                months -= d1.getMonth();
                months += d2.getMonth();
                if (d2.getDate() < d1.getDate()) months--;
                document.getElementById('manual-gap-display').textContent = `Gap: ${Math.abs(months)} months`;
            } else {
                document.getElementById('manual-gap-display').textContent = `Gap: --`;
            }
            
            // ===== NEW LOGIC: Calculate G, G1, G2 by subtracting years =====
            // G Date = First Insurance Date - G offset (in years)
            // G2 Date = First Insurance Date - G2 offset (in years)
            // G1 Date = First Insurance Date - G1 offset (in years)
            
            if (firstInsStr && d1) {
                console.log('[CALC] Calculating G/G2/G1 dates based on first insurance date');
                
                // Get the offset values from the input fields
                const gOffset = parseFloat(document.getElementById('manual-g-offset').value) || 0;
                const g2Offset = parseFloat(document.getElementById('manual-g2-offset').value) || 0;
                const g1Offset = parseFloat(document.getElementById('manual-g1-offset').value) || 0;
                
                console.log('[CALC] Offsets - G:', gOffset, 'G2:', g2Offset, 'G1:', g1Offset);
                
                // Create dates by subtracting years
                const gDate = new Date(d1);
                gDate.setFullYear(gDate.getFullYear() - gOffset);
                
                const g2Date = new Date(d1);
                g2Date.setFullYear(g2Date.getFullYear() - g2Offset);
                
                const g1Date = new Date(d1);
                g1Date.setFullYear(g1Date.getFullYear() - g1Offset);
                
                // Format dates as MM/DD/YYYY
                const formatDate = (date) => {
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${month}/${day}/${year}`;
                };
                
                const gDateStr = formatDate(gDate);
                const g2DateStr = formatDate(g2Date);
                const g1DateStr = formatDate(g1Date);
                
                console.log('[CALC] Calculated dates - G:', gDateStr, 'G2:', g2DateStr, 'G1:', g1DateStr);
                
                // Display the calculated dates
                document.getElementById('copy-manual-g-date').value = gDateStr;
                document.getElementById('copy-manual-g2-date').value = g2DateStr;
                document.getElementById('copy-manual-g1-date').value = g1DateStr;
                
                console.log('[CALC] ✓ G/G1/G2 dates updated successfully');
            } else {
                console.log('[CALC] Cannot calculate - missing first insurance date');
                document.getElementById('copy-manual-g-date').value = '';
                document.getElementById('copy-manual-g2-date').value = '';
                document.getElementById('copy-manual-g1-date').value = '';
            }
        }
        
        function formatISOToDisplay(isoDate) {
            if (!isoDate || isoDate === 'Not available in document') return '';
            
            // Handle YYYY-MM-DD or YYYY/MM/DD
            const parts = isoDate.split(/[-/]/);
            if (parts.length === 3) {
                // If first part is 4 digits, it's YYYY-MM-DD
                if (parts[0].length === 4) {
                    return `${parts[1].padStart(2, '0')}/${parts[2].padStart(2, '0')}/${parts[0]}`;
                }
                // If last part is 4 digits, it's MM/DD/YYYY or DD/MM/YYYY
                if (parts[2].length === 4) {
                    return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
                }
            }
            return isoDate; // Return as is if we can't parse it
        }

        // --- NAVIGATION LOGIC ---

        function switchEntryMode(mode) {
            const btnAuto = document.getElementById('btn-entry-auto');
            const btnProp = document.getElementById('btn-entry-property');
            const formAuto = document.getElementById('entry-form-auto');
            const formProp = document.getElementById('entry-form-property');
            const headerBar = document.getElementById('header-bar');
            const previewTitle = document.getElementById('preview-title');
            const driverContainer = document.getElementById('driver-select-container');
            const propertyContainer = document.getElementById('property-select-container');

            if (mode === 'auto') {
                // Button Styles
                btnAuto.classList.add('bg-slate-800', 'text-white', 'shadow-sm');
                btnAuto.classList.remove('text-slate-500');
                btnProp.classList.remove('bg-slate-800', 'text-white', 'shadow-sm');
                btnProp.classList.add('text-slate-500');
                
                // Form Visibility
                formAuto.classList.remove('hidden');
                formProp.classList.add('hidden');

                // Header Styling
                headerBar.classList.remove('bg-emerald-600');
                headerBar.classList.add('bg-indigo-600');
                previewTitle.textContent = "Auto Preview";
                
                // Toggle Dropdowns
                driverContainer.classList.remove('hidden');
                propertyContainer.classList.add('hidden');

                // Auto switch preview tab
                switchTab('preview');
            } else {
                // Button Styles
                btnProp.classList.add('bg-slate-800', 'text-white', 'shadow-sm');
                btnProp.classList.remove('text-slate-500');
                btnAuto.classList.remove('bg-slate-800', 'text-white', 'shadow-sm');
                btnAuto.classList.add('text-slate-500');

                // Form Visibility
                formProp.classList.remove('hidden');
                formAuto.classList.add('hidden');

                // Header Styling
                headerBar.classList.remove('bg-indigo-600');
                headerBar.classList.add('bg-emerald-600');
                previewTitle.textContent = "Property Preview";
                
                // Toggle Dropdowns
                driverContainer.classList.add('hidden');
                propertyContainer.classList.remove('hidden');

                // Auto switch preview tab
                switchTab('property');
            }
        }

        function switchTab(tabName) {
            // Tabs styles
            document.querySelectorAll('.preview-tab').forEach(tab => {
                tab.classList.remove('active-tab', 'text-indigo-600', 'bg-indigo-50', 'text-emerald-600', 'bg-emerald-50');
                tab.classList.add('text-slate-500');
            });
            
            // Hide contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('block');
            });
            
            // Select Tab Button Index
            let tabIndex = 0;
            if(tabName === 'copy') tabIndex = 1;
            if(tabName === 'property') tabIndex = 2;

            const activeBtn = document.querySelectorAll('.preview-tab')[tabIndex];
            activeBtn.classList.remove('text-slate-500');

            if (tabName === 'property') {
                activeBtn.classList.add('active-tab', 'text-emerald-600', 'bg-emerald-50');
            } else {
                activeBtn.classList.add('active-tab', 'text-indigo-600', 'bg-indigo-50');
            }

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('block');
        }
        
        function copyToClipboard(inputId, btnElement) {
            // For view elements generated dynamically
            let input = document.getElementById(inputId);
            
            // Fallback: Check if the ID was passed raw or as 'view-...' 
            // In the update loop below I used explicit field IDs from propertiesData keys
            // But generatePropertyGrid uses field IDs directly.
            // Let's ensure we are targeting the VIEW inputs on the right side.
            
            // If the element doesn't exist, it might be inside the Shadow DOM or just a mismatch.
            if(!input) return;

            input.select();
            document.execCommand('copy');
            const icon = btnElement.querySelector('i');
            const originalClass = icon.className;
            icon.className = 'fa-solid fa-check text-emerald-500';
            setTimeout(() => { icon.className = originalClass; }, 1000);
        }
        
        function selectDocType(driverNum, docType) {
            driverDocTypes[driverNum] = docType;
            const row = document.querySelector(`[data-driver="${driverNum}"]`);
            row.querySelectorAll('.doc-pill').forEach(pill => {
                pill.className = 'doc-pill h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate border-slate-200 bg-white text-slate-500 hover:bg-slate-50 hover:border-slate-300 hover:text-slate-700';
                if (pill.dataset.type === docType) {
                    pill.className = 'doc-pill active h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate bg-slate-800 text-white border-slate-800 shadow-sm';
                }
            });
            document.getElementById(`file-${driverNum}`).click();
        }
        
        function handleFileUpload(driverNum) {
            const fileInput = document.getElementById(`file-${driverNum}`);
            const row = document.querySelector(`[data-driver="${driverNum}"]`);
            let activePill = null;
            row.querySelectorAll('.doc-pill').forEach(pill => {
                if(pill.classList.contains('active')) activePill = pill;
            });
            if (fileInput.files.length > 0 && activePill) {
                activePill.className = 'doc-pill uploaded h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate bg-emerald-50 text-emerald-700 border-emerald-200 relative pr-7';
                const docType = activePill.dataset.type;
                activePill.innerHTML = `<i class="fa-solid fa-check mr-1"></i> ${docType.toUpperCase()}<span class="remove-doc absolute right-1 top-1/2 -translate-y-1/2 w-4 h-4 rounded-full hover:bg-rose-100 hover:text-rose-600 text-emerald-600 flex items-center justify-center cursor-pointer transition-colors" onclick="removeFile(${driverNum}, '${docType}', event)"><i class="fa-solid fa-times text-[9px]"></i></span>`;
                
                // If DASH document, parse it and populate fields
                if (docType === 'dash') {
                    parseDASHPDF(fileInput.files[0], driverNum);
                }
                
                // If MVR document, parse it and populate MVR INFO fields
                if (docType === 'mvr') {
                    parseMVRPDF(fileInput.files[0], driverNum);
                }
                
                updatePreview();
            }
        }
        
        async function parseDASHPDF(file, driverNum) {
            try {
                console.log(`[DASH] Parsing DASH PDF for driver ${driverNum}: ${file.name}`);
                
                // IMPORTANT: Clear old data for this driver before parsing new file
                parsedDASHData[driverNum] = null;
                parsedGDates[driverNum] = null;  // Clear cached G dates
                console.log(`[DASH] Cleared old DASH data and G dates for driver ${driverNum}`);
                
                // Send file to backend parser
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/parse-dash', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    console.log(`[DASH] Successfully parsed. Full data object:`, result.data);
                    console.log(`[DASH] All keys in data:`, Object.keys(result.data));
                    console.log(`[DASH] startOfEarliestTerm value:`, result.data.startOfEarliestTerm);
                    console.log(`[DASH] firstInsuranceDate value:`, result.data.firstInsuranceDate);
                    
                    const data = result.data;
                    
                    // === POPULATE COPY TAB (READ-ONLY FIELDS) ===
                    
                    // Name
                    if (data.name && data.name !== '-') {
                        document.getElementById('copy-name').value = data.name;
                        document.getElementById('prev-name').textContent = data.name;
                    }
                    
                    // DOB
                    if (data.dob && data.dob !== '-') {
                        document.getElementById('copy-dob').value = data.dob;
                    }
                    
                    // License/DLN
                    if (data.dln && data.dln !== '-') {
                        document.getElementById('copy-license').value = data.dln;
                        document.getElementById('prev-dln').textContent = data.dln;
                    }
                    
                    // Address
                    if (data.address && data.address !== '-') {
                        document.getElementById('copy-address').value = data.address;
                        document.getElementById('prev-address').textContent = data.address;
                    }
                    
                    // === POPULATE PREVIEW TAB (HISTORY & CLAIMS) ===
                    
                    // Non-pay history (3 years)
                    if (data.history_nonpay_3y && data.history_nonpay_3y !== '-') {
                        document.getElementById('prev-nonpay').textContent = data.history_nonpay_3y;
                    }
                    
                    // Claims history (6 years)
                    if (data.claims_6y && data.claims_6y !== '-') {
                        document.getElementById('prev-claims').textContent = data.claims_6y;
                    }
                    
                    // First party claims (6 years)
                    if (data.first_party_6y && data.first_party_6y !== '-') {
                        document.getElementById('prev-firstparty').textContent = data.first_party_6y;
                    }
                    
                    // === POPULATE CURRENT POLICY INFO ===
                    
                    // Insurance company
                    if (data.current_company && data.current_company !== '-') {
                        document.getElementById('prev-company').textContent = data.current_company;
                        document.getElementById('copy-company-insured').value = data.current_company;
                    }
                    
                    // Current expiry date - show in preview
                    if (data.current_policy_expiry && data.current_policy_expiry !== '-') {
                        // Calculate days until expiry
                        const expiryDate = new Date(data.current_policy_expiry);
                        const today = new Date();
                        const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                        
                        let daysText = '';
                        if (daysLeft > 0) {
                            daysText = `${daysLeft} days`;
                        } else if (daysLeft === 0) {
                            daysText = 'Today';
                        } else {
                            // Policy is expired
                            daysText = `EXPIRED - ${Math.abs(daysLeft)} days ago`;
                        }
                        
                        // Show date with days in brackets in Current Policy "Expiry In" field
                        document.getElementById('prev-days-expiry').textContent = `${data.current_policy_expiry} (${daysText})`;
                    }
                    
                    // Continuous insurance years
                    if (data.years_continuous_insurance && data.years_continuous_insurance !== '-') {
                        document.getElementById('copy-cont-ins').value = data.years_continuous_insurance + ' years';
                    }
                    
                    // === POPULATE MANUAL FIRST INSURANCE DATE ===
                    console.log(`[DASH] startOfEarliestTerm:`, data.startOfEarliestTerm);
                    console.log(`[DASH] firstInsuranceDate:`, data.firstInsuranceDate);
                    
                    // Use whichever is available
                    const insuranceDate = data.startOfEarliestTerm || data.firstInsuranceDate;
                    
                    if (insuranceDate && insuranceDate !== 'Not available in document') {
                        const manualFirstIns = document.getElementById('manual-first-ins');
                        console.log(`[DASH] Found manual-first-ins element:`, manualFirstIns !== null);
                        
                        if (manualFirstIns) {
                            // Ensure date is in YYYY-MM-DD format for formatting
                            let dateToFormat = insuranceDate;
                            if (insuranceDate.includes('/') && !insuranceDate.match(/^\d{4}/)) {
                                // Already in MM/DD/YYYY format, use as-is
                                manualFirstIns.value = insuranceDate;
                            } else {
                                // Format YYYY-MM-DD to MM/DD/YYYY
                                const formattedDate = formatISOToDisplay(insuranceDate);
                                console.log(`[DASH] Formatted date from ${insuranceDate} to ${formattedDate}`);
                                manualFirstIns.value = formattedDate;
                            }
                            
                            console.log(`[DASH] Set manual-first-ins.value to: ${manualFirstIns.value}`);
                            
                            // Trigger calculation after a small delay to ensure DOM is ready
                            setTimeout(() => {
                                calculateManualDates();
                            }, 100);
                        } else {
                            console.log(`[DASH] ERROR: manual-first-ins element not found`);
                        }
                    } else {
                        console.log(`[DASH] No insurance date available`);
                    }
                    
                    // === POPULATE DEMOGRAPHICS ===
                    
                    // Build demographics string: Gender, Marital Status, Years Licensed, Claims Free
                    const demoDetails = [];
                    if (data.gender && data.gender !== '-') demoDetails.push(data.gender === 'F' ? 'Female' : data.gender === 'M' ? 'Male' : data.gender);
                    if (data.marital_status && data.marital_status !== '-') demoDetails.push(data.marital_status);
                    if (data.years_licensed && data.years_licensed !== '-') demoDetails.push(`${data.years_licensed} years licensed`);
                    if (data.years_claims_free && data.years_claims_free !== '-') demoDetails.push(`${data.years_claims_free} years claims-free`);
                    
                    if (demoDetails.length > 0) {
                        document.getElementById('prev-demo').textContent = demoDetails.join(' • ');
                    }
                    
                    // === POPULATE VEHICLES & OPERATORS COUNTS ===
                    
                    console.log(`[DASH] Vehicles count from data: ${data.current_vehicles_count}`);
                    console.log(`[DASH] Operators count from data: ${data.current_operators_count}`);
                    
                    if (data.current_vehicles_count && data.current_vehicles_count !== '-') {
                        console.log(`[DASH] Setting vehicles count to: ${data.current_vehicles_count}`);
                        document.getElementById('prev-vehicles-count').textContent = data.current_vehicles_count;
                        // Also update the list display
                        const vehiclesListEl = document.getElementById('prev-vehicles-list');
                        if (vehiclesListEl) {
                            vehiclesListEl.textContent = `${data.current_vehicles_count} vehicles on active policy`;
                        }
                    } else {
                        console.log(`[DASH] Vehicles count is empty or "-"`);
                    }
                    
                    if (data.current_operators_count && data.current_operators_count !== '-') {
                        console.log(`[DASH] Setting operators count to: ${data.current_operators_count}`);
                        document.getElementById('prev-operators-count').textContent = data.current_operators_count;
                        // Also update the list display
                        const operatorsListEl = document.getElementById('prev-operators-list');
                        if (operatorsListEl) {
                            operatorsListEl.textContent = `${data.current_operators_count} operators on active policy`;
                        }
                    } else {
                        console.log(`[DASH] Operators count is empty or "-"`);
                    }
                    
                    // === G/G1/G2 DATES - NOT POPULATED FROM DASH ===
                    // G/G1/G2 calculation requires BOTH DASH (firstInsuranceDate) and MVR (issueDate)
                    // Calculation happens in /api/calculate-g-dates when combination is requested
                    if (data.g_calculation_note) {
                        console.log(`[DASH] ${data.g_calculation_note}`);
                    }
                    
                    // Store DASH data for combination calculation
                    parsedDASHData[driverNum] = data;
                    console.log(`[DASH] Stored DASH data for driver ${driverNum}`);
                    
                    // Update display if viewing this driver
                    if (currentDisplayDriver === driverNum) {
                        switchDriverView(driverNum);
                    }
                    
                    // Try to calculate combination if both DASH and MVR are available
                    calculateCombinationDates(driverNum);
                    
                    console.log(`[DASH] ✓ Form fields populated successfully`);
                } else {
                    const errors = result.errors || ['Unknown error'];
                    console.warn(`[DASH] Parsing failed:`, errors);
                    console.log(`[DASH] Error details: ${errors.join(', ')}`);
                }
            } catch (error) {
                console.error(`[DASH] Network/fetch error:`, error);
            }
        }
        
        async function parseMVRPDF(file, driverNum) {
            try {
                console.log(`[MVR] Parsing MVR PDF for driver ${driverNum}: ${file.name}`);
                
                // IMPORTANT: Clear old data for this driver before parsing new file
                parsedMVRData[driverNum] = null;
                parsedGDates[driverNum] = null;  // Clear cached G dates
                console.log(`[MVR] Cleared old MVR data and G dates for driver ${driverNum}`);
                
                // Send file to backend MVR parser
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/parse-mvr', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.mvr_data) {
                    console.log(`[MVR] Successfully parsed. Document type: ${result.document_type}`);
                    console.log(`[MVR] Extracted MVR data:`, result.mvr_data);
                    
                    const data = result.mvr_data;
                    
                    // === POPULATE MVR INFO SECTION (STRICT MODE) ===
                    // Populate ONLY: Convictions, Birth Date, Expiry, Exp. (Yrs), Convictions List
                    
                    // Convictions Count
                    if (data.convictions_count && data.convictions_count !== 'Not available in document') {
                        console.log(`[MVR] Setting convictions count to: ${data.convictions_count}`);
                        document.getElementById('mvr-convictions').textContent = data.convictions_count;
                    } else {
                        console.log(`[MVR] Convictions count not available`);
                        document.getElementById('mvr-convictions').textContent = '—';
                    }
                    
                    // Birth Date
                    if (data.birth_date && data.birth_date !== 'Not available in document') {
                        console.log(`[MVR] Setting birth date to: ${data.birth_date}`);
                        document.getElementById('mvr-birthdate').textContent = data.birth_date;
                    } else {
                        console.log(`[MVR] Birth date not available`);
                        document.getElementById('mvr-birthdate').textContent = '—';
                    }

                    // === POPULATE MANUAL ISSUE DATE ===
                    if (data.issue_date && data.issue_date !== 'Not available in document') {
                        const manualIssueDate = document.getElementById('manual-issue-date');
                        if (manualIssueDate) {
                            if (data.issue_date.includes('/')) {
                                manualIssueDate.value = data.issue_date;
                            } else {
                                manualIssueDate.value = formatISOToDisplay(data.issue_date);
                            }
                            calculateManualDates();
                        }
                    }
                    
                    // Licence Expiry Date
                    if (data.licence_expiry_date && data.licence_expiry_date !== 'Not available in document') {
                        console.log(`[MVR] Setting expiry date to: ${data.licence_expiry_date}`);
                        document.getElementById('mvr-expiry').textContent = data.licence_expiry_date;

                        // Calculate experience in years from issue date if available
                        if (data.issue_date && data.issue_date !== 'Not available in document') {
                            const issueDate = new Date(data.issue_date);
                            const today = new Date();
                            let yearsExp = (today - issueDate) / (1000 * 60 * 60 * 24 * 365.25);
                            yearsExp = yearsExp > 0 ? yearsExp.toFixed(1) : '0';
                            console.log(`[MVR] Calculated experience (years) from issue date: ${yearsExp}`);
                            document.getElementById('mvr-experience').textContent = yearsExp;
                        } else {
                            document.getElementById('mvr-experience').textContent = '—';
                        }
                    } else {
                        console.log(`[MVR] Expiry date not available`);
                        document.getElementById('mvr-expiry').textContent = '—';
                        document.getElementById('mvr-experience').textContent = '—';
                    }
                    
                    // Convictions List (if any)
                    if (data.convictions && data.convictions.length > 0) {
                        console.log(`[MVR] Found ${data.convictions.length} convictions`);
                        let convictionsList = '';
                        data.convictions.forEach((conviction, index) => {
                            // Handle both string and object formats
                            if (typeof conviction === 'string') {
                                convictionsList += `<div class="mb-1 pb-1 border-b border-slate-200 last:border-b-0">`;
                                convictionsList += `<div class="text-xs text-slate-600">${conviction}</div>`;
                                convictionsList += `</div>`;
                            } else {
                                // Object format with date and description
                                convictionsList += `<div class="mb-2 pb-2 border-b border-slate-200 last:border-b-0">`;
                                convictionsList += `<div class="text-xs font-semibold text-slate-700">${conviction.date || 'Date N/A'}</div>`;
                                convictionsList += `<div class="text-xs text-slate-600">${conviction.description || 'Description N/A'}</div>`;
                                convictionsList += `</div>`;
                            }
                        });
                        document.getElementById('mvr-convictions-list').innerHTML = convictionsList;
                    } else if (data.convictions_count === '0') {
                        console.log(`[MVR] No convictions found`);
                        document.getElementById('mvr-convictions-list').textContent = 'No convictions on record';
                    } else {
                        console.log(`[MVR] Convictions list not available`);
                        document.getElementById('mvr-convictions-list').textContent = '—';
                    }
                    
                    // === G/G1/G2 DATES - NOT POPULATED FROM MVR ===
                    // G/G1/G2 calculation requires BOTH DASH (firstInsuranceDate) and MVR (issueDate)
                    // Calculation happens in /api/calculate-g-dates when combination is requested
                    console.log(`[MVR] G/G1/G2 calculated during combination endpoint`);
                    
                    // Store MVR data for combination calculation
                    parsedMVRData[driverNum] = result.mvr_data;
                    console.log(`[MVR] Stored MVR data for driver ${driverNum}`);
                    
                    // Update display if viewing this driver
                    if (currentDisplayDriver === driverNum) {
                        switchDriverView(driverNum);
                    }
                    
                    // Try to calculate combination if both DASH and MVR are available
                    calculateCombinationDates(driverNum);
                    
                    console.log(`[MVR] ✓ MVR INFO section populated successfully`);
                } else {
                    const errors = result.errors || ['Unknown error'];
                    console.warn(`[MVR] Parsing failed:`, errors);
                    console.log(`[MVR] Error details: ${errors.join(', ')}`);
                }
            } catch (error) {
                console.error(`[MVR] Network/fetch error:`, error);
            }
        }
        
        // Function to calculate combination dates when both DASH and MVR are available
        async function calculateCombinationDates(driverNum) {
            console.log(`[COMBINATION] Attempting to calculate for driver ${driverNum}`);
            
            // Check if both DASH and MVR data are available
            const dashData = parsedDASHData[driverNum];
            const mvrData = parsedMVRData[driverNum];
            
            if (!dashData || !mvrData) {
                console.log(`[COMBINATION] Waiting for both DASH and MVR. DASH: ${!!dashData}, MVR: ${!!mvrData}`);
                return;
            }
            
            // Prepare combined data in the format expected by license_history_integration
            const combinedData = {
                driver: dashData,  // DASH data contains firstInsuranceDate
                mvr_data: mvrData  // MVR data contains issue_date, licence_expiry_date, birth_date
            };
            
            console.log(`[COMBINATION] Both documents available.`);
            console.log(`[COMBINATION] DASH firstInsuranceDate: ${dashData.firstInsuranceDate}`);
            console.log(`[COMBINATION] MVR issue_date: ${mvrData.issue_date}`);
            console.log(`[COMBINATION] MVR licence_expiry_date: ${mvrData.licence_expiry_date}`);
            console.log(`[COMBINATION] Full combinedData:`, combinedData);
            
            try {
                const response = await fetch('/api/calculate-g-dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'pdf',
                        pdf_data: combinedData
                    })
                });
                
                const data = await response.json();
                console.log(`[COMBINATION] API response:`, data);
                console.log(`[COMBINATION] G date value: "${data.g_date}", G2 value: "${data.g2_date}", G1 value: "${data.g1_date}"`);
                console.log(`[COMBINATION] Success: ${data.success}, Calculation performed: ${data.calculation_performed}`);
                
                if (data.success && data.calculation_performed) {
                    // Check if driver has less than 5 years experience
                    // Compare MVR licence_expiry_date day/month with birth_date day/month
                    const birthDate = mvrData.birth_date;
                    const licenceExpiryDate = mvrData.licence_expiry_date;
                    
                    console.log(`[COMBINATION] Birth date: ${birthDate}, Licence expiry date: ${licenceExpiryDate}`);
                    
                    let hasInsufficientExperience = false;
                    
                    if (birthDate && licenceExpiryDate) {
                        // Extract day and month from both dates
                        // Assuming format is YYYY-MM-DD or MM/DD/YYYY
                        let birthMonth, birthDay;
                        let expiryMonth, expiryDay;
                        
                        if (birthDate.includes('-')) {
                            // YYYY-MM-DD format
                            const parts = birthDate.split('-');
                            birthMonth = parts[1];
                            birthDay = parts[2];
                        } else if (birthDate.includes('/')) {
                            // MM/DD/YYYY format
                            const parts = birthDate.split('/');
                            birthMonth = parts[0];
                            birthDay = parts[1];
                        }
                        
                        if (licenceExpiryDate.includes('-')) {
                            // YYYY-MM-DD format
                            const parts = licenceExpiryDate.split('-');
                            expiryMonth = parts[1];
                            expiryDay = parts[2];
                        } else if (licenceExpiryDate.includes('/')) {
                            // MM/DD/YYYY format
                            const parts = licenceExpiryDate.split('/');
                            expiryMonth = parts[0];
                            expiryDay = parts[1];
                        }
                        
                        // Compare day and month (ignore year)
                        if (birthMonth !== expiryMonth || birthDay !== expiryDay) {
                            hasInsufficientExperience = true;
                            console.log(`[COMBINATION] ⚠ Day/Month mismatch - Birth: ${birthMonth}/${birthDay}, Expiry: ${expiryMonth}/${expiryDay}`);
                        } else {
                            console.log(`[COMBINATION] ✓ Day/Month match - Birth: ${birthMonth}/${birthDay}, Expiry: ${expiryMonth}/${expiryDay}`);
                        }
                    }
                    
                    if (hasInsufficientExperience) {
                        // Customer has less than 5 years of experience
                        console.log(`[COMBINATION] ⚠ Insufficient experience detected`);
                        
                        // Store per-driver
                        parsedGDates[driverNum] = {
                            message: 'Customer has less than 5 years of experience',
                            g_date: '',
                            g2_date: '',
                            g1_date: ''
                        };
                        
                        console.log(`[COMBINATION] ✓ Stored insufficient experience message for driver ${driverNum}`);
                        
                        // Refresh display to show the message
                        if (currentDisplayDriver === driverNum) {
                            switchDriverView(driverNum);
                            console.log(`[COMBINATION] ✓ Refreshed display with insufficient experience message for driver ${driverNum}`);
                        }
                    } else {
                        // Populate the combination section (1 MAX) with calculated dates
                        // API already returns dates in MM/DD/YYYY format, no need to reformat
                        const gDateFormatted = data.g_date || '';
                        const g2DateFormatted = data.g2_date || '';
                        const g1DateFormatted = data.g1_date || '';
                        
                        console.log(`[COMBINATION] Dates from API - G: "${gDateFormatted}", G2: "${g2DateFormatted}", G1: "${g1DateFormatted}"`);
                        
                        // Store per-driver
                        parsedGDates[driverNum] = {
                            g_date: gDateFormatted,
                            g2_date: g2DateFormatted,
                            g1_date: g1DateFormatted,
                            message: ''
                        };
                        
                        console.log(`[COMBINATION] ✓ Stored G dates for driver ${driverNum}`);
                        console.log(`[COMBINATION] G: ${data.g_date}, G2: ${data.g2_date}, G1: ${data.g1_date}`);
                        
                        // Refresh display to show the calculated dates
                        if (currentDisplayDriver === driverNum) {
                            switchDriverView(driverNum);
                            console.log(`[COMBINATION] ✓ Refreshed display for driver ${driverNum}`);
                        }
                    }
                } else if (data.error) {
                    console.error(`[COMBINATION] Calculation error: ${data.error}`);
                    // If error is about insufficient experience, show in UI
                    if (data.error && data.error.toLowerCase().includes('less than 5 years')) {
                        parsedGDates[driverNum] = {
                            message: data.error,
                            g_date: '',
                            g2_date: '',
                            g1_date: ''
                        };
                        if (currentDisplayDriver === driverNum) {
                            switchDriverView(driverNum);
                        }
                    }
                } else {
                    console.log(`[COMBINATION] Note: ${data.note}`);
                }
            } catch (err) {
                console.error(`[COMBINATION] API call failed:`, err);
            }
        }
        
        function removeFile(driverNum, docType, event) {
            event.stopPropagation();
            const row = document.querySelector(`[data-driver="${driverNum}"]`);
            const pills = row.querySelectorAll('.doc-pill');
            let targetPill = null;
            pills.forEach(pill => { if (pill.dataset.type === docType) targetPill = pill; });
            if (targetPill) {
                targetPill.textContent = docType === 'dash' ? 'DASH' : docType === 'autoplus' ? 'Auto+' : 'MVR';
                if (driverDocTypes[driverNum] === docType) {
                     targetPill.className = 'doc-pill active h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate bg-slate-800 text-white border-slate-800 shadow-sm';
                } else {
                     targetPill.className = 'doc-pill h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate border-slate-200 bg-white text-slate-500 hover:bg-slate-50 hover:border-slate-300 hover:text-slate-700';
                }
                const fileInput = document.getElementById(`file-${driverNum}`);
                if (fileInput) fileInput.value = '';
                updatePreview();
            }
        }
        
        function updateDriverRel(driverNum) {
            const relSelect = document.getElementById(`rel-${driverNum}`);
            const dropdown = document.getElementById('driverSelect');
            const option = dropdown.querySelector(`option[value="${driverNum}"]`);
            if (option && relSelect) {
                const relText = relSelect.options[relSelect.selectedIndex].text;
                option.textContent = `Driver ${driverNum} (${relText})`;
            }
            updatePreview();
        }
        
        function addDriver() {
            driverCount++;
            driverDocTypes[driverCount] = 'dash';
            const container = document.getElementById('driversList');
            const driverHTML = `<div class="upload-row group relative bg-white rounded-xl p-1 border border-slate-200 shadow-sm hover:border-indigo-300 hover:shadow-md transition-all" data-driver="${driverCount}"><div class="bg-slate-50/50 rounded-lg p-3"><div class="flex items-center gap-3 mb-3"><div class="driver-num w-6 h-6 rounded-full bg-slate-200 text-slate-600 text-xs font-bold flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-colors shadow-sm">${driverCount}</div><div class="flex-1 grid grid-cols-3 gap-2 doc-type-pills"><button type="button" class="doc-pill active h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate bg-slate-800 text-white border-slate-800 shadow-sm" data-type="dash" onclick="selectDocType(${driverCount}, 'dash')">DASH</button><button type="button" class="doc-pill h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate border-slate-200 bg-white text-slate-500 hover:bg-slate-50 hover:border-slate-300 hover:text-slate-700" data-type="autoplus" onclick="selectDocType(${driverCount}, 'autoplus')">Auto+</button><button type="button" class="doc-pill h-8 text-[10px] font-bold border rounded-md transition-all text-center truncate border-slate-200 bg-white text-slate-500 hover:bg-slate-50 hover:border-slate-300 hover:text-slate-700" data-type="mvr" onclick="selectDocType(${driverCount}, 'mvr')">MVR</button></div></div><div class="pl-9"><select id="rel-${driverCount}" onchange="updateDriverRel(${driverCount})" class="h-9 w-full bg-white border border-slate-200 text-slate-700 text-xs font-medium rounded-lg focus:ring-2 focus:ring-indigo-500/10 focus:border-indigo-500 block px-3 transition-all cursor-pointer hover:border-slate-300"><option value="">Select Relationship</option><option value="spouse">Spouse</option><option value="son">Son</option><option value="daughter">Daughter</option><option value="parent">Parent</option><option value="sibling">Sibling</option><option value="other">Other</option></select><input type="file" id="file-${driverCount}" class="hidden" accept=".pdf" onchange="handleFileUpload(${driverCount})"></div></div></div>`;
            container.insertAdjacentHTML('beforeend', driverHTML);
            
            // Create new page button in driver pages navigation
            const pagesNav = document.getElementById('driver-pages-nav');
            const newPageBtn = document.createElement('button');
            newPageBtn.className = 'driver-page-btn h-9 px-4 bg-white border border-slate-200 text-slate-600 text-xs font-semibold rounded-lg hover:bg-slate-50 hover:border-indigo-300 hover:text-indigo-600 transition-all';
            newPageBtn.innerHTML = `<i class="fa-solid fa-user mr-2"></i>Driver ${driverCount}`;
            newPageBtn.setAttribute('onclick', `switchDriverPage(${driverCount})`);
            newPageBtn.setAttribute('data-driver', driverCount);
            pagesNav.appendChild(newPageBtn);
            
            // Add to old dropdown for compatibility
            const dropdown = document.getElementById('driverSelect');
            const newOption = document.createElement('option');
            newOption.value = driverCount;
            newOption.textContent = `Driver ${driverCount} (Relationship)`;
            dropdown.appendChild(newOption);
            
            // Auto switch to new driver page
            switchDriverPage(driverCount);
            updatePreview();
        }
        
        function switchDriverPage(driverNum) {
            // Update button styles
            document.querySelectorAll('.driver-page-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white', 'shadow-sm', 'hover:bg-indigo-700');
                btn.classList.add('bg-white', 'border', 'border-slate-200', 'text-slate-600', 'hover:bg-slate-50', 'hover:border-indigo-300', 'hover:text-indigo-600');
            });
            
            // Activate current driver button
            const activeBtn = document.querySelector(`[data-driver="${driverNum}"].driver-page-btn`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-white', 'border', 'border-slate-200', 'text-slate-600', 'hover:bg-slate-50', 'hover:border-indigo-300', 'hover:text-indigo-600');
                activeBtn.classList.add('active', 'bg-indigo-600', 'text-white', 'shadow-sm', 'hover:bg-indigo-700');
            }
            
            // Switch to driver in dropdown and update preview
            currentDisplayDriver = driverNum;
            document.getElementById('driverSelect').value = driverNum;
            switchDriverView(driverNum);
        }
        
        function switchDriverView(driverId) {
            console.log(`[DISPLAY] Switching to driver ${driverId} view`);
            
            // Get the data for this driver
            const dashData = parsedDASHData[driverId];
            const mvrData = parsedMVRData[driverId];
            
            console.log(`[DISPLAY] Driver ${driverId} - DASH: ${!!dashData}, MVR: ${!!mvrData}`);
            
            // Add fade effect
            const previewSide = document.querySelector('.bg-slate-50.h-full.overflow-y-auto');
            if (previewSide) {
                previewSide.classList.add('opacity-50');
                setTimeout(() => previewSide.classList.remove('opacity-50'), 200);
            }
            
            // Clear all current display fields first
            clearDriverDisplay();
            
            // If driver has DASH data, display it
            if (dashData) {
                console.log(`[DISPLAY] Populating DASH data for driver ${driverId}`);
                
                document.getElementById('prev-name').textContent = dashData.name || '—';
                document.getElementById('prev-dln').textContent = dashData.dln || '—';
                document.getElementById('prev-address').textContent = dashData.address || '—';
                
                // Demographics
                const demoDetails = [];
                if (dashData.gender && dashData.gender !== '-') demoDetails.push(dashData.gender === 'F' ? 'Female' : dashData.gender === 'M' ? 'Male' : dashData.gender);
                if (dashData.marital_status && dashData.marital_status !== '-') demoDetails.push(dashData.marital_status);
                if (dashData.years_licensed && dashData.years_licensed !== '-') demoDetails.push(`${dashData.years_licensed} years licensed`);
                if (dashData.years_claims_free && dashData.years_claims_free !== '-') demoDetails.push(`${dashData.years_claims_free} years claims-free`);
                if (demoDetails.length > 0) {
                    document.getElementById('prev-demo').textContent = demoDetails.join(' • ');
                }
                
                // History
                document.getElementById('prev-nonpay').textContent = dashData.history_nonpay_3y || '—';
                document.getElementById('prev-claims').textContent = dashData.claims_6y || '—';
                document.getElementById('prev-firstparty').textContent = dashData.first_party_6y || '—';
                document.getElementById('prev-gaps').textContent = dashData.dcpd_6y || '—';
                
                // Current Policy
                document.getElementById('prev-company').textContent = dashData.current_company || '—';
                
                // Calculate expiry days and show as date (days left/expired)
                if (dashData.current_policy_expiry) {
                    const expiryDate = new Date(dashData.current_policy_expiry);
                    const today = new Date();
                    const daysLeft = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
                    const expiryDateStr = expiryDate.toLocaleDateString('en-CA'); // YYYY-MM-DD
                    let daysText = '—';
                    if (daysLeft > 0) {
                        daysText = `${expiryDateStr} (expiring in ${daysLeft} days)`;
                    } else if (daysLeft < 0) {
                        daysText = `${expiryDateStr} (EXPIRED - ${Math.abs(daysLeft)} days ago)`;
                    } else {
                        daysText = `${expiryDateStr} (Today)`;
                    }
                    document.getElementById('prev-days-expiry').textContent = daysText;
                    document.getElementById('prev-days-expiry').className = daysLeft < 0 ? 'text-sm font-bold text-rose-600 bg-rose-50 px-2 py-0.5 rounded' : 'text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded';
                }
                
                document.getElementById('prev-vehicles-count').textContent = dashData.current_vehicles_count || '—';
                document.getElementById('prev-operators-count').textContent = dashData.current_operators_count || '—';
                
                // Vehicles & Operators lists
                if (dashData.current_vehicles_count && dashData.current_vehicles_count !== '-') {
                    document.getElementById('prev-vehicles-list').textContent = `${dashData.current_vehicles_count} vehicles on active policy`;
                }
                if (dashData.current_operators_count && dashData.current_operators_count !== '-') {
                    document.getElementById('prev-operators-list').textContent = `${dashData.current_operators_count} operators on active policy`;
                }
                
                // === ALSO UPDATE COPY TAB FIELDS FOR THIS DRIVER ===
                // Add null checks before setting values
                const copyNameEl = document.getElementById('copy-name');
                if (copyNameEl) copyNameEl.value = dashData.name || '—';
                
                const copyDlnEl = document.getElementById('copy-dln');
                if (copyDlnEl) copyDlnEl.value = dashData.dln || '—';
                
                const copyAddressEl = document.getElementById('copy-address');
                if (copyAddressEl) copyAddressEl.value = dashData.address || '—';
            }
            
            // If driver has MVR data, display it
            if (mvrData) {
                console.log(`[DISPLAY] Populating MVR data for driver ${driverId}`);
                
                document.getElementById('mvr-birthdate').textContent = mvrData.birth_date || '—';
                document.getElementById('mvr-expiry').textContent = mvrData.licence_expiry_date || '—';
                document.getElementById('mvr-convictions').textContent = mvrData.convictions_count || '—';

                // Calculate experience in years from issue date if available
                if (mvrData.issue_date && mvrData.issue_date !== 'Not available in document') {
                    const issueDate = new Date(mvrData.issue_date);
                    const today = new Date();
                    let yearsExp = (today - issueDate) / (1000 * 60 * 60 * 24 * 365.25);
                    if (!isNaN(issueDate.getTime())) {
                        if (yearsExp >= 0) {
                            document.getElementById('mvr-experience').textContent = yearsExp.toFixed(1);
                        } else {
                            document.getElementById('mvr-experience').textContent = '0';
                        }
                    } else {
                        document.getElementById('mvr-experience').textContent = '—';
                    }
                } else {
                    document.getElementById('mvr-experience').textContent = '—';
                }
                
                // Convictions list
                if (mvrData.convictions && mvrData.convictions.length > 0) {
                    let convictionsList = '';
                    mvrData.convictions.forEach(conviction => {
                        // Handle both object and string formats
                        if (typeof conviction === 'string') {
                            convictionsList += `<div class="mb-1 pb-1 border-b border-slate-200 last:border-b-0">`;
                            convictionsList += `<div class="text-xs text-slate-600">${conviction}</div>`;
                            convictionsList += `</div>`;
                        } else {
                            // Object format with date and description
                            convictionsList += `<div class="mb-2 pb-2 border-b border-slate-200 last:border-b-0">`;
                            convictionsList += `<div class="text-xs font-semibold text-slate-700">${conviction.date || 'Date N/A'}</div>`;
                            convictionsList += `<div class="text-xs text-slate-600">${conviction.description || 'Description N/A'}</div>`;
                            convictionsList += `</div>`;
                        }
                    });
                    document.getElementById('mvr-convictions-list').innerHTML = convictionsList;
                } else if (mvrData.convictions_count === '0') {
                    // No convictions on record
                    document.getElementById('mvr-convictions-list').textContent = 'No convictions on record';
                } else {
                    // Convictions not available
                    document.getElementById('mvr-convictions-list').textContent = '—';
                }
            }
            
            // Display G/G1/G2 dates if calculated
            const gDates = parsedGDates[driverId];
            // Remove any previous warning message in the Combinations section
            let combSection = document.getElementById('combinations-section');
            if (combSection) {
                let warnEl = combSection.querySelector('#combination-warning');
                if (warnEl) warnEl.remove();
            }

            if (gDates) {
                if (gDates.message) {
                    // Insufficient experience message
                    document.getElementById('copy-g-date').value = '';
                    document.getElementById('copy-g2-date').value = '';
                    document.getElementById('copy-g1-date').value = '';
                    document.getElementById('copy-g-date').placeholder = gDates.message;
                    document.getElementById('copy-g2-date').placeholder = gDates.message;
                    document.getElementById('copy-g1-date').placeholder = gDates.message;
                    // Show warning in Combinations section only
                    let combSection = document.getElementById('combinations-section');
                    if (combSection && !combSection.querySelector('#combination-warning')) {
                        const msgDiv = document.createElement('div');
                        msgDiv.id = 'combination-warning';
                        msgDiv.className = 'mt-4 mb-2 text-sm font-bold text-rose-700 bg-rose-50 border border-rose-200 rounded px-4 py-2 flex items-center gap-2';
                        msgDiv.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-2"></i>' + gDates.message;
                        combSection.insertBefore(msgDiv, combSection.firstChild.nextSibling);
                    }
                    console.log(`[DISPLAY] Showing insufficient experience message for driver ${driverId}`);
                } else {
                    // Show calculated dates
                    document.getElementById('copy-g-date').value = gDates.g_date || '';
                    document.getElementById('copy-g2-date').value = gDates.g2_date || '';
                    document.getElementById('copy-g1-date').value = gDates.g1_date || '';
                    document.getElementById('copy-g-date').placeholder = '';
                    document.getElementById('copy-g2-date').placeholder = '';
                    document.getElementById('copy-g1-date').placeholder = '';
                    console.log(`[DISPLAY] Showing G dates for driver ${driverId}: G=${gDates.g_date}, G2=${gDates.g2_date}, G1=${gDates.g1_date}`);
                }
            } else {
                // No G dates calculated yet
                document.getElementById('copy-g-date').value = '';
                document.getElementById('copy-g2-date').value = '';
                document.getElementById('copy-g1-date').value = '';
                document.getElementById('copy-g-date').placeholder = '';
                document.getElementById('copy-g2-date').placeholder = '';
                document.getElementById('copy-g1-date').placeholder = '';
                console.log(`[DISPLAY] No G dates for driver ${driverId}`);
            }
            
            console.log(`[DISPLAY] ✓ Driver ${driverId} view populated`);
        }
        
        function clearDriverDisplay() {
            console.log('[DISPLAY] Clearing all driver display fields');
            
            // DASH fields
            document.getElementById('prev-name').textContent = '—';
            document.getElementById('prev-dln').textContent = '—';
            document.getElementById('prev-address').textContent = '—';
            document.getElementById('prev-demo').textContent = '—';
            document.getElementById('prev-nonpay').textContent = '—';
            document.getElementById('prev-claims').textContent = '—';
            document.getElementById('prev-firstparty').textContent = '—';
            document.getElementById('prev-gaps').textContent = '—';
            document.getElementById('prev-company').textContent = '—';
            document.getElementById('prev-days-expiry').textContent = '—';
            document.getElementById('prev-vehicles-count').textContent = '0';
            document.getElementById('prev-operators-count').textContent = '0';
            document.getElementById('prev-vehicles-list').textContent = '—';
            document.getElementById('prev-operators-list').textContent = '—';
            
            // MVR fields
            document.getElementById('mvr-birthdate').textContent = '—';
            document.getElementById('mvr-expiry').textContent = '—';
            document.getElementById('mvr-convictions').textContent = '—';
            document.getElementById('mvr-experience').textContent = '—';
            document.getElementById('mvr-convictions-list').textContent = '—';
        }
        
        function clearForm() {
            if (confirm('Clear all data?')) {
                document.getElementById('quoteFormAuto').reset();
                document.getElementById('quoteFormProperty').reset();
                const container = document.getElementById('driversList');
                while (container.children.length > 1) { container.removeChild(container.lastChild); }
                
                // Reset driver pages navigation
                const pagesNav = document.getElementById('driver-pages-nav');
                pagesNav.innerHTML = `<button class="driver-page-btn active h-9 px-4 bg-indigo-600 text-white text-xs font-semibold rounded-lg shadow-sm hover:bg-indigo-700 transition-all" onclick="switchDriverPage(1)" data-driver="1">
                    <i class="fa-solid fa-user mr-2"></i>Driver 1
                </button>`;
                
                driverCount = 1;
                driverDocTypes = { 1: 'dash' };
                const dropdown = document.getElementById('driverSelect');
                dropdown.innerHTML = '<option value="1">Driver 1 (Applicant)</option>';
                selectDocType(1, 'dash'); 
                updatePreview();
                updatePropertyPreview();
            }
        }
        
        function updatePreview() {
            // Auto Update Logic (Existing)
            document.getElementById('prev-ownership').textContent = document.querySelector('input[name="ownership"]:checked')?.value.charAt(0).toUpperCase() + document.querySelector('input[name="ownership"]:checked')?.value.slice(1) || 'Owned';
            document.getElementById('prev-use').textContent = document.querySelector('input[name="use"]:checked')?.value.charAt(0).toUpperCase() + document.querySelector('input[name="use"]:checked')?.value.slice(1) || 'Pleasure';
            document.getElementById('prev-km').textContent = parseInt(document.getElementById('annualKm').value || 0).toLocaleString();
            document.getElementById('prev-winter').textContent = document.querySelector('input[name="winterTires"]:checked')?.value.charAt(0).toUpperCase() + document.querySelector('input[name="winterTires"]:checked')?.value.slice(1) || 'Yes';
            document.getElementById('prev-antitheft').textContent = document.querySelector('input[name="antiTheft"]:checked')?.value.charAt(0).toUpperCase() + document.querySelector('input[name="antiTheft"]:checked')?.value.slice(1) || 'No';
            document.getElementById('prev-phone').textContent = document.getElementById('phone').value || '—';
            document.getElementById('prev-email').textContent = document.getElementById('email').value || '—';
            document.getElementById('copy-phone').value = document.getElementById('phone').value || '—';
            document.getElementById('copy-email').value = document.getElementById('email').value || '—';
            document.getElementById('copy-annual-km').value = document.getElementById('annualKm').value || '—';
            document.getElementById('copy-vehicle-condition').value = (document.querySelector('input[name="ownership"]:checked')?.value || '—') + ' / ' + (document.querySelector('input[name="use"]:checked')?.value || '—');
        }

        // --- PROPERTY VIEW LOGIC ---
        
        function generatePropertyGrid() {
            const container = document.getElementById('property-preview-grid');
            
            const fieldGroups = {
                'Location': [
                    { key: 'address', label: 'Address' },
                    { key: 'city', label: 'City' },
                    { key: 'postal', label: 'Postal' },
                    { key: 'lender', label: 'Lender' },
                    { key: 'mortCount', label: '# Mortgages' }
                ],
                'Dwelling Info': [
                    { key: 'built', label: 'Year Built' },
                    { key: 'storeys', label: 'Storeys' },
                    { key: 'units', label: 'Units' },
                    { key: 'families', label: 'Families' },
                    { key: 'purchased', label: 'Purchased' },
                    { key: 'ownerOcc', label: 'Owner Occ', type: 'radio' },
                    { key: 'inlaw', label: 'In-law', type: 'radio' },
                    { key: 'bsmtApt', label: 'Bsmt Apt', type: 'radio' }
                ],
                'Area & Systems': [
                    { key: 'livingArea', label: 'Living SqFt' },
                    { key: 'bsmtArea', label: 'Bsmt SqFt' },
                    { key: 'bsmtFin', label: 'Bsmt Fin %' },
                    { key: 'elec', label: 'Electrical' },
                    { key: 'plumb', label: 'Plumbing' },
                    { key: 'roof', label: 'Roofing' },
                    { key: 'heat', label: 'Heating' },
                    { key: 'fullBaths', label: 'Full Baths' },
                    { key: 'halfBaths', label: 'Half Baths' }
                ],
                'Security': [
                    { key: 'burglar', label: 'Burglar', type: 'checkbox' },
                    { key: 'fire', label: 'Fire Alarm', type: 'checkbox' },
                    { key: 'sprinkler', label: 'Sprinkler', type: 'checkbox' },
                    { key: 'smoke', label: '# Smoke Det' },
                    { key: 'ext', label: '# Extinguish' },
                    { key: 'blockwatch', label: 'Block Watch', type: 'checkbox' },
                    { key: 'walled', label: 'Walled', type: 'checkbox' },
                    { key: 'deadbolts', label: 'Deadbolts', type: 'checkbox' }
                ]
            };

            let html = '';
            
            for (const [groupName, fields] of Object.entries(fieldGroups)) {
                html += `
                    <div class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden">
                        <div class="bg-emerald-50/50 px-5 py-3 border-b border-emerald-100 flex items-center justify-between">
                            <span class="text-[10px] font-bold text-emerald-900 uppercase tracking-widest">${groupName}</span>
                        </div>
                        <div class="p-5 space-y-3">
                `;
                
                fields.forEach(field => {
                    const uniqueId = `view-${field.key}`;
                    html += `
                        <div class="flex items-center gap-3">
                            <label class="w-24 text-[11px] font-semibold text-slate-500 text-right truncate flex-shrink-0">${field.label}</label>
                            <input type="text" id="${uniqueId}" value="—" readonly 
                                class="h-9 flex-1 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md px-3 font-mono focus:outline-none">
                            <button onclick="copyToClipboard('${uniqueId}', this)" class="h-9 w-9 flex items-center justify-center rounded-md bg-white border border-slate-200 text-slate-400 hover:text-emerald-600 hover:border-emerald-200 hover:bg-emerald-50 transition-all flex-shrink-0">
                                <i class="fa-regular fa-clipboard"></i>
                            </button>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            container.innerHTML = html;
        }

        function updatePropertyPreview() {
            const data = propertiesData[viewPropId]; // Use VIEW ID not Active ID
            if(!data) return;

            const allKeys = Object.keys(data); // 'address', 'city' ...

            allKeys.forEach(key => {
                let val = data[key];
                
                // Handle booleans for checkboxes
                if (typeof val === 'boolean') {
                    val = val ? 'Yes' : 'No';
                }
                
                // Handle empties
                if (val === '' || val === null || val === undefined) {
                    val = '—';
                }

                const targetId = `view-${key}`;
                const el = document.getElementById(targetId);
                if(el) el.value = val;
            });
        }

        // Listeners
        document.getElementById('quoteFormAuto').addEventListener('submit', function(e) { e.preventDefault(); alert('Auto Quote Saved!'); });
        document.getElementById('quoteFormProperty').addEventListener('submit', function(e) { e.preventDefault(); alert('Property Quote Saved!'); });
        
        document.getElementById('annualKm').addEventListener('input', updatePreview);
        document.getElementById('phone').addEventListener('input', updatePreview);
        document.getElementById('email').addEventListener('input', updatePreview);
        document.querySelectorAll('input[type=radio]').forEach(r => r.addEventListener('change', updatePreview));
        
        // Initial run
        renderPropertyTabs();
        generatePropertyGrid();
        updatePreview();
        updatePropertyPreview();
        
        // Load leads data for search
        console.log('[INIT] Loading leads data...');
        loadAllLeads().then(() => {
            console.log('[INIT] Leads loaded, checking for URL parameters...');
            
            // Check for URL parameters from meta dashboard and auto-populate
            const urlParams = new URLSearchParams(window.location.search);
            const leadId = urlParams.get('leadId');
            const leadName = urlParams.get('leadName');
            const leadPhone = urlParams.get('leadPhone');
            const leadEmail = urlParams.get('leadEmail');
            
            if (leadId && leadName) {
                console.log('[INIT] Auto-populating from meta dashboard:', leadName, leadPhone, leadEmail);
                selectLead(leadName, leadPhone, leadId, leadEmail);
            }
        });
    </script>
</body>
</html>